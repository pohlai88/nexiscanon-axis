# help002-erp-doctype-contract.md

**Status:** SUPPORTING (Help)
**Why this exists:** ERP drifts fastest when every module invents its own “document” shape.

## Non-negotiable
Any ERP entity that users treat as a document (Order, Move, Invoice, Journal Entry, Transfer) MUST follow the **DocType contract** below.

You can add fields, but you may not remove or reinterpret the core fields.

---

## 1) Core DocType fields
These fields exist on the “header” record.

### Identity
- `id` (UUID or ULID)
- `tenant_id` (required)
- `doc_type` (string literal, e.g. `"SALES_ORDER"`)
- `doc_no` (string; generated by Sequence service)

### Lifecycle
- `status` (enum; defined by module workflow)
- `created_at`, `created_by`
- `updated_at`, `updated_by`

### Counterparty / Context
- `party_id` (Partner/Customer/Vendor when applicable)
- `currency_code` (ISO)

### Totals (if financial)
- `subtotal_amount`
- `tax_amount` (optional early)
- `total_amount`

### Audit linkage
- `chronos_id` (optional; if you have a unified trace id)

---

## 2) DocLine fields (when there are lines)
If a document has lines, lines MUST be a separate table.

- `id`
- `tenant_id`
- `doc_id` (FK to header)
- `line_no` (integer; stable ordering)
- `product_id` (when applicable)
- `description` (optional)
- `qty`
- `uom_id`
- `unit_price` (when applicable)
- `line_amount` (derived or stored)

Rule: Lines are never embedded JSON arrays for core transactional documents.

---

## 3) Sequence rules (doc_no)
- Every DocType MUST have a sequence key: `seq.<doc_type>`.
- Sequence allocation happens in the domain service, not UI.
- `doc_no` must be unique within `tenant_id + doc_type`.

Recommended format:
- `SO-2026-000123`
- `PO-2026-000045`

---

## 4) Status rules
- Status transitions must be explicit and validated by a transition table (see help003).
- A document may be **DRAFT** without side effects.
- “Posting” is the moment side effects become durable (stock moves, ledger entries, etc.).

---

## 5) Idempotency rules
For any side-effecting action (Submit, Approve, Post):
- Use an idempotency key (request id) stored in an action log table, or
- Ensure transitions are guarded so repeated calls are safe.

---

## 6) Minimal DocTypes (recommended baseline)
Start with these common doc types:
- `SALES_ORDER`
- `PURCHASE_ORDER`
- `STOCK_MOVE`
- `INVOICE`

---

## 7) What NOT to do
- Do not let UI invent `doc_no`.
- Do not store lines in JSONB for transactional docs.
- Do not allow ad-hoc statuses without schema + transition validation.
