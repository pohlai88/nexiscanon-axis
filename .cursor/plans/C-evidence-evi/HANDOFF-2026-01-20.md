# Development Handoff - Session End 2026-01-20

## Current Status Summary

**Context Window:** Near full (113K+ tokens used)  
**Last Milestone:** EVI004 (Jobs/Queue) ‚úÖ COMPLETE  
**Next Milestone:** EVI005 (Auth Integration) - Ready to start

---

## Evidence Chain Status

| Evidence | Status      | Notes                                                                       |
| -------- | ----------- | --------------------------------------------------------------------------- |
| EVI001   | ‚úÖ COMPLETE | API Kernel pattern enforcement                                              |
| EVI002-A | ‚úÖ COMPLETE | Database proof (Neon + Drizzle + RLS)                                       |
| EVI002-B | ‚úÖ COMPLETE | HTTP proof (create + cross-tenant isolation)                                |
| EVI002-C | ‚úÖ COMPLETE | Tenant isolation (RLS policies + indexes)                                   |
| EVI003   | ‚è≥ PARTIAL  | Errors ‚úÖ (GlitchTip working), Traces ‚è≥ (needs env + Grafana verification) |
| EVI004   | ‚úÖ COMPLETE | Jobs/Queue (Graphile Worker with tenant context)                            |
| EVI005   | üìã READY    | Auth Integration (Neon Auth) - Planned, not started                         |

---

## What Was Accomplished This Session

### 1. Fixed GlitchTip Integration (EVI003 Partial)

- **Issue:** Sentry v10+ API changed, `withScope` no longer exported from `@sentry/nextjs`
- **Fix:** Updated `packages/observability/src/errors.ts` to use `@sentry/core` API
- **Result:** Errors captured successfully with `axis.*` correlation tags
- **Event ID:** `917ae52a8c3545e6a50194a859817e4e`
- **Status:** Errors pillar ‚úÖ, traces pillar ‚è≥ (needs OTEL endpoint + Grafana verification)

### 2. Implemented Jobs/Queue System (EVI004 Complete)

- **Package:** `@workspace/jobs` with Graphile Worker wrapper
- **Features:**
  - Type-safe job envelope (tenantId, actorId, traceId, payload)
  - Kernel-wrapped enqueue endpoint (`POST /api/jobs/enqueue`)
  - Worker process with 2 proof jobs (system.ping, requests.reminder)
  - Full tenant context propagation
  - TraceId correlation (API ‚Üí worker logs)
- **Evidence:** All 5 items captured and verified
- **Scripts:**
  - `pnpm worker` - Start worker
  - `.\scripts\start-worker.ps1` - Start worker with env loaded
  - `.\scripts\start-with-otel.ps1` - Start dev server with observability env

### 3. Documentation Updates

- Updated `NEXT-STEPS.md` with current roadmap
- Created `EVI004-JOBS-QUEUE.md` with complete evidence
- Created `EVI004-EXECUTION.md` with step-by-step commands
- Updated `EVI003-OBSERVABILITY-STITCH.md` with accurate status

---

## Current Architecture State

### Packages Structure

```
packages/
‚îú‚îÄ‚îÄ api-kernel/          ‚úÖ 8 routes verified, CI gates passing
‚îú‚îÄ‚îÄ app-runtime/         ‚úÖ Bootstrap + DI container
‚îú‚îÄ‚îÄ auth/                ‚ö†Ô∏è  Stub only (dev mode) - NEEDS REAL AUTH
‚îú‚îÄ‚îÄ db/                  ‚úÖ Neon + Drizzle + RLS
‚îú‚îÄ‚îÄ design-system/       ‚úÖ Shadcn/UI components
‚îú‚îÄ‚îÄ domain/              ‚úÖ Odoo-inspired addons pattern
‚îú‚îÄ‚îÄ eslint-config/       ‚úÖ Shared ESLint rules
‚îú‚îÄ‚îÄ jobs/                ‚úÖ Graphile Worker wrapper (NEW)
‚îú‚îÄ‚îÄ observability/       ‚è≥ Errors ‚úÖ, traces pending
‚îî‚îÄ‚îÄ validation/          ‚úÖ Zod schemas
```

### Active Services

- **Dev Server:** `pnpm --filter web dev:webpack` or `.\scripts\start-with-otel.ps1`
- **Worker:** `pnpm worker` or `.\scripts\start-worker.ps1`
- **Database:** Neon PostgreSQL (connectionless)

### Environment Variables (env.localCopy)

```env
DATABASE_URL=postgresql://...           # Neon PostgreSQL
SENTRY_DSN=https://...@app.glitchtip.com/19580  # GlitchTip errors
OTEL_EXPORTER_OTLP_ENDPOINT=https://...grafana.net/otlp  # Grafana Cloud (traces pending)
NEON_AUTH_BASE_URL=https://...neonauth...  # Neon Auth (not yet used)
```

---

## Next Steps (EVI005 - Auth Integration)

### Goal

Replace `auth: { mode: "dev" }` with real Neon Auth provider + JWT validation.

### Implementation Plan

**Phase 1: Auth Provider Setup**

1. Update `packages/auth/src/providers/auth-provider.tsx`
   - Integrate Neon Auth SDK
   - Implement login/signup/logout
   - Session management

2. Update `packages/auth/src/handlers/`
   - Real login handler (POST /api/auth/login)
   - Real signup handler (POST /api/auth/signup)
   - Logout handler (POST /api/auth/logout)
   - Session check (GET /api/auth/session)

**Phase 2: Kernel Integration** 3. Update `packages/api-kernel/src/auth.ts`

- Extract JWT from Authorization header
- Validate against Neon Auth JWKS
- Extract actorId + roles from token claims

4. Migrate routes from dev mode
   - Change `auth: { mode: "dev" }` ‚Üí `auth: { mode: "required" }`
   - Test with real JWT tokens

**Phase 3: Evidence Capture (EVI005)** 5. Execute proof workflow:

- Signup new user
- Login (get JWT)
- Create request with JWT (no dev headers)
- Verify actorId in logs matches JWT sub claim
- Query DB to confirm actorId stored correctly

### Key Files to Modify

```
packages/auth/src/
‚îú‚îÄ‚îÄ providers/auth-provider.tsx    # Neon Auth integration
‚îú‚îÄ‚îÄ handlers/*.ts                  # Real auth endpoints
‚îî‚îÄ‚îÄ hooks/use-auth.ts             # Client-side auth state

packages/api-kernel/src/
‚îú‚îÄ‚îÄ auth.ts                        # JWT extraction + validation
‚îî‚îÄ‚îÄ types.ts                       # May need AuthResult updates

apps/web/app/api/
‚îú‚îÄ‚îÄ auth/*/route.ts               # Auth endpoints (login/signup/logout)
‚îî‚îÄ‚îÄ requests/route.ts             # Example: migrate to auth: required
```

### Environment Variables Needed

```env
NEON_AUTH_BASE_URL=https://...neonauth.../auth  # Already in env.localCopy
JWKS_URL=https://...neonauth.../.well-known/jwks.json  # Already in env.localCopy
```

### Acceptance Criteria (EVI005)

- [ ] Neon Auth SDK integrated
- [ ] Login/signup endpoints working
- [ ] JWT validation in kernel
- [ ] Routes migrated from dev mode to required mode
- [ ] Evidence captured: signup ‚Üí login ‚Üí create request ‚Üí verify actorId
- [ ] No dev headers needed (Authorization: Bearer <JWT> only)

---

## Technical Debt / Known Issues

### 1. OTEL Traces Not Verified (EVI003)

- **Issue:** Grafana Cloud traces pending verification
- **Blocker:** None (not blocking development)
- **Fix:** Load OTEL env vars ‚Üí generate requests ‚Üí query Grafana Tempo
- **Token:** Needs rotation (exposed in chat)

### 2. Windows Turbopack Issue

- **Issue:** Symlink privilege error (`os error 1314`)
- **Workaround:** Use `pnpm --filter web dev:webpack` (stable)
- **Alternative:** Enable Windows Developer Mode

### 3. Auth Currently Dev-Only

- **Issue:** All routes use `auth: { mode: "dev" }` with fake headers
- **Impact:** Cannot deploy to production
- **Fix:** EVI005 (next milestone)

---

## Development Commands Reference

### Start Services

```powershell
# Dev server (with observability)
.\scripts\start-with-otel.ps1

# Worker (background jobs)
.\scripts\start-worker.ps1

# Dev server (without OTEL env - simpler)
pnpm --filter web dev:webpack
```

### Verification Commands

```powershell
# Check API kernel
pnpm -w check:api-kernel

# Check DB migrations
pnpm -w check:db-migrations

# Type check core packages
pnpm -w typecheck:core

# Lint all packages
pnpm -w lint
```

### Database Commands

```powershell
# Generate migration
pnpm -w db:generate

# Apply migration
pnpm -w db:migrate

# Push schema (dev only)
pnpm -w db:push

# Open Drizzle Studio
pnpm -w db:studio

# Query via Docker psql
$dbUrl = (Get-Content env.localCopy | Select-String "^DATABASE_URL=" | ForEach-Object { $_.ToString().Replace("DATABASE_URL=","") })
docker run --rm postgres:16-alpine psql "$dbUrl" -c "<query>"
```

---

## Files Modified This Session

### New Files Created

```
packages/jobs/                           # NEW: Background jobs package
  ‚îú‚îÄ‚îÄ src/
  ‚îÇ   ‚îú‚îÄ‚îÄ client.ts
  ‚îÇ   ‚îú‚îÄ‚îÄ enqueue.ts
  ‚îÇ   ‚îú‚îÄ‚îÄ types.ts
  ‚îÇ   ‚îî‚îÄ‚îÄ index.ts
  ‚îú‚îÄ‚îÄ package.json
  ‚îú‚îÄ‚îÄ tsconfig.json
  ‚îî‚îÄ‚îÄ README.md

apps/web/app/api/jobs/enqueue/route.ts  # NEW: Job enqueue endpoint

scripts/
  ‚îú‚îÄ‚îÄ run-worker.ts                     # NEW: Worker entrypoint
  ‚îú‚îÄ‚îÄ start-worker.ps1                  # NEW: Worker startup with env
  ‚îú‚îÄ‚îÄ start-with-otel.ps1               # NEW: Dev server with OTEL env
  ‚îî‚îÄ‚îÄ query-jobs.ts                     # NEW: Query Graphile Worker jobs

.cursor/plans/C-evidence-evi/
  ‚îú‚îÄ‚îÄ EVI004-JOBS-QUEUE.md              # NEW: Jobs evidence document
  ‚îú‚îÄ‚îÄ EVI004-EXECUTION.md               # NEW: Execution guide
  ‚îî‚îÄ‚îÄ HANDOFF-2026-01-20.md             # NEW: This handoff document
```

### Modified Files

```
packages/observability/src/errors.ts    # FIXED: Sentry v10+ API
apps/web/instrumentation.ts             # FIXED: OTEL headers support
package.json                            # ADDED: worker script
.cursor/plans/C-evidence-evi/
  ‚îú‚îÄ‚îÄ EVI003-OBSERVABILITY-STITCH.md    # UPDATED: Status to PARTIAL
  ‚îî‚îÄ‚îÄ NEXT-STEPS.md                     # UPDATED: EVI004 complete, EVI005 next
```

---

## Critical Context for Next Session

### 1. Auth Mode Pattern

All routes currently use dev mode:

```typescript
auth: {
  mode: 'dev';
} // ‚Üê Accepts dev headers, no JWT validation
```

After EVI005, production routes should use:

```typescript
auth: {
  mode: 'required';
} // ‚Üê Requires valid JWT, extracts actorId
```

### 2. Neon Auth Integration

- Already provisioned (NEON_AUTH_BASE_URL in env)
- SDK: Use Neon Auth client or Better Auth (Neon Auth is built on Better Auth)
- JWKS URL for validation already in env
- Need to implement session management

### 3. Tenant Context

Tenant resolution happens **before** auth:

```typescript
// Kernel flow:
1. Extract X-Tenant-ID header ‚Üí ctx.tenantId
2. Extract auth (JWT or dev) ‚Üí ctx.actorId + ctx.roles
3. Enforce tenant requirement (if configured)
4. Enforce auth requirement (if configured)
5. Run handler
```

This means auth doesn't need to know about tenants - it only validates identity.

### 4. Job Queue Ready

Background jobs are now available for:

- Async workflows (file processing, email)
- Scheduled tasks (cleanup, reminders)
- Long-running operations

Use pattern:

```typescript
import { createWorkerUtils, enqueueJob } from '@workspace/jobs';

const utils = await createWorkerUtils(process.env.DATABASE_URL!);
const jobId = await enqueueJob(utils, 'job.name', {
  tenantId: ctx.tenantId!,
  actorId: ctx.actorId,
  traceId: ctx.traceId,
  requestId: ctx.requestId,
  payload: {
    /* job-specific data */
  },
});
await utils.release();
```

---

## Questions for Next Session

1. **Neon Auth SDK:** Use Better Auth client directly or Neon Auth wrapper?
2. **Session Storage:** Store in PostgreSQL or use Neon Auth session management?
3. **Migration Strategy:** Migrate all routes at once or incrementally?
4. **Dev Mode:** Keep `auth: { mode: "dev" }` for testing or remove entirely?

---

## Success Metrics (EVI005)

Evidence capture must show:

1. User signup successful (returns userId)
2. User login successful (returns JWT)
3. Create request with JWT (no dev headers)
4. Logs show real actorId (from JWT sub claim)
5. DB query confirms actorId matches JWT

**When these 5 items are verified ‚Üí EVI005 = COMPLETE ‚úÖ**

---

## Repository State

**Branch:** Foundation
**Status:** All changes committed and pushed to GitHub
**Build Status:** Clean (no lint/type errors)  
**Tests:** Not run (no test suite yet)

**Ready for:** EVI005 implementation

---

**End of Handoff - Ready for New Session** üöÄ
