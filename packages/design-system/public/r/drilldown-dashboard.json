{
  "$schema": "https://ui.shadcn.com/schema/registry-item.json",
  "name": "drilldown-dashboard",
  "type": "registry:block",
  "title": "Drilldown Dashboard (Quorum)",
  "description": "Interactive KPI dashboard with hierarchical drill-down navigation, sparklines, and dimension-based filtering",
  "categories": [
    "quorum",
    "analysis",
    "dashboard"
  ],
  "registryDependencies": [
    "card",
    "button",
    "tooltip"
  ],
  "dependencies": [
    "recharts"
  ],
  "devDependencies": [],
  "files": [
    {
      "path": "src/blocks/quorum/drilldown-dashboard.tsx",
      "type": "registry:component",
      "content": "\"use client\"\n\n/**\n * Drilldown Dashboard - Quorum Kernel Component\n *\n * Interactive dashboard with click-to-drill-down functionality.\n * Implements A01-CANONICAL.md §4 — \"Surface the truth before they ask\"\n *\n * Features:\n * - KPI cards with drill-down\n * - Breadcrumb navigation for drill path\n * - Compare periods\n * - Trend sparklines\n * - Export functionality\n *\n * @example\n * ```tsx\n * import { DrilldownDashboard } from \"@workspace/design-system\"\n *\n * <DrilldownDashboard\n *   kpis={kpiData}\n *   onDrillDown={(kpiId, dimension) => loadDetails(kpiId, dimension)}\n *   onExport={(kpiId) => exportData(kpiId)}\n * />\n * ```\n */\n\nimport * as React from \"react\"\nimport { cn } from \"@/lib/utils\"\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/card\"\nimport { Badge } from \"@/components/badge\"\nimport { Button } from \"@/components/button\"\nimport { Progress } from \"@/components/progress\"\nimport {\n  Breadcrumb,\n  BreadcrumbItem,\n  BreadcrumbLink,\n  BreadcrumbList,\n  BreadcrumbPage,\n  BreadcrumbSeparator,\n} from \"@/components/breadcrumb\"\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"@/components/dropdown-menu\"\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/tooltip\"\nimport {\n  TrendingUp,\n  TrendingDown,\n  Minus,\n  ChevronRight,\n  Download,\n  RefreshCw,\n  Filter,\n  Calendar,\n  MoreVertical,\n  ArrowLeft,\n  Loader2,\n  Sparkles,\n  AlertTriangle,\n  Target,\n  ChevronDown,\n} from \"lucide-react\"\n\n// ============================================================================\n// Types (TrendDirection imported from shared types to avoid conflicts)\n// ============================================================================\n\nimport type { TrendDirection } from \"../types\"\n\nexport type KPIStatus = \"on_track\" | \"at_risk\" | \"off_track\" | \"achieved\"\n\nexport interface DrillDimension {\n  id: string\n  label: string\n  type: \"time\" | \"category\" | \"entity\" | \"location\" | \"custom\"\n}\n\nexport interface SparklineData {\n  values: number[]\n  labels?: string[]\n}\n\nexport interface KPIData {\n  id: string\n  name: string\n  value: number | string\n  formattedValue: string\n  previousValue?: number | string\n  target?: number | string\n  formattedTarget?: string\n  unit?: string\n  trend?: {\n    direction: TrendDirection\n    percentage: number\n    period: string\n  }\n  status?: KPIStatus\n  sparkline?: SparklineData\n  drillDimensions?: DrillDimension[]\n  description?: string\n  lastUpdated?: string | Date\n  isLoading?: boolean\n  aiInsight?: string\n}\n\nexport interface DrilldownLevel {\n  kpiId: string\n  dimensionId: string\n  dimensionValue: string\n  label: string\n}\n\nexport interface DrilldownDashboardProps {\n  /** KPI data */\n  kpis: KPIData[]\n  /** Drill down callback - returns new KPIs for the drill level */\n  onDrillDown?: (kpiId: string, dimension: DrillDimension, currentPath: DrilldownLevel[]) => Promise<KPIData[]>\n  /** Export callback */\n  onExport?: (kpiId: string, format: \"csv\" | \"excel\" | \"pdf\") => void\n  /** Refresh callback */\n  onRefresh?: (kpiId?: string) => Promise<void>\n  /** Current drill path */\n  drillPath?: DrilldownLevel[]\n  /** Title */\n  title?: string\n  /** Description */\n  description?: string\n  /** Show AI insights */\n  showAIInsights?: boolean\n  /** Grid columns */\n  columns?: 2 | 3 | 4\n  /** Custom className */\n  className?: string\n}\n\n// ============================================================================\n// Constants\n// ============================================================================\n\nconst STATUS_CONFIG: Record<\n  KPIStatus,\n  { color: string; bgColor: string; label: string }\n> = {\n  on_track: { color: \"text-green-600\", bgColor: \"bg-green-100\", label: \"On Track\" },\n  at_risk: { color: \"text-amber-600\", bgColor: \"bg-amber-100\", label: \"At Risk\" },\n  off_track: { color: \"text-red-600\", bgColor: \"bg-red-100\", label: \"Off Track\" },\n  achieved: { color: \"text-blue-600\", bgColor: \"bg-blue-100\", label: \"Achieved\" },\n}\n\n// ============================================================================\n// Helper Components\n// ============================================================================\n\nfunction TrendIndicator({ trend }: { trend: KPIData[\"trend\"] }) {\n  if (!trend) return null\n\n  const Icon =\n    trend.direction === \"up\"\n      ? TrendingUp\n      : trend.direction === \"down\"\n      ? TrendingDown\n      : Minus\n\n  const isPositive = trend.direction === \"up\"\n  const isNegative = trend.direction === \"down\"\n\n  return (\n    <TooltipProvider>\n      <Tooltip>\n        <TooltipTrigger>\n          <div\n            className={cn(\n              \"inline-flex items-center gap-1 rounded px-1.5 py-0.5 text-xs font-medium\",\n              isPositive && \"bg-green-100 text-green-700\",\n              isNegative && \"bg-red-100 text-red-700\",\n              !isPositive && !isNegative && \"bg-gray-100 text-gray-700\"\n            )}\n          >\n            <Icon className=\"h-3 w-3\" />\n            {trend.percentage > 0 ? \"+\" : \"\"}\n            {trend.percentage}%\n          </div>\n        </TooltipTrigger>\n        <TooltipContent>\n          <p>\n            {trend.direction === \"up\" ? \"Increased\" : trend.direction === \"down\" ? \"Decreased\" : \"No change\"}{\" \"}\n            {trend.percentage}% vs {trend.period}\n          </p>\n        </TooltipContent>\n      </Tooltip>\n    </TooltipProvider>\n  )\n}\n\nfunction StatusBadge({ status }: { status?: KPIStatus }) {\n  if (!status) return null\n  const config = STATUS_CONFIG[status]\n  return (\n    <Badge className={cn(\"text-xs\", config.bgColor, config.color, \"border-0\")}>\n      {config.label}\n    </Badge>\n  )\n}\n\nfunction MiniSparkline({ data }: { data: SparklineData }) {\n  const { values } = data\n  if (!values || values.length === 0) return null\n\n  const max = Math.max(...values)\n  const min = Math.min(...values)\n  const range = max - min || 1\n\n  const points = values\n    .map((value, index) => {\n      const x = (index / (values.length - 1)) * 100\n      const y = 100 - ((value - min) / range) * 100\n      return `${x},${y}`\n    })\n    .join(\" \")\n\n  const isPositive = values[values.length - 1] >= values[0]\n\n  return (\n    <svg className=\"h-8 w-24\" viewBox=\"0 0 100 100\" preserveAspectRatio=\"none\">\n      <polyline\n        points={points}\n        fill=\"none\"\n        stroke={isPositive ? \"#22c55e\" : \"#ef4444\"}\n        strokeWidth=\"3\"\n        strokeLinecap=\"round\"\n        strokeLinejoin=\"round\"\n      />\n    </svg>\n  )\n}\n\nfunction ProgressToTarget({ value, target }: { value: number; target: number }) {\n  const percentage = Math.min((value / target) * 100, 100)\n  const isComplete = value >= target\n\n  return (\n    <div className=\"space-y-1\">\n      <div className=\"flex justify-between text-xs\">\n        <span className=\"text-muted-foreground\">Target</span>\n        <span className={cn(isComplete ? \"text-green-600\" : \"text-muted-foreground\")}>\n          {percentage.toFixed(0)}%\n        </span>\n      </div>\n      <Progress\n        value={percentage}\n        className={cn(\"h-1.5\", isComplete && \"[&>div]:bg-green-500\")}\n      />\n    </div>\n  )\n}\n\n// ============================================================================\n// KPI Card\n// ============================================================================\n\nfunction KPICard({\n  kpi,\n  onDrillDown,\n  onExport,\n  onRefresh,\n  showAIInsights,\n}: {\n  kpi: KPIData\n  onDrillDown?: (dimension: DrillDimension) => void\n  onExport?: (format: \"csv\" | \"excel\" | \"pdf\") => void\n  onRefresh?: () => Promise<void>\n  showAIInsights: boolean\n}) {\n  const [isRefreshing, setIsRefreshing] = React.useState(false)\n  const [showDrillMenu, setShowDrillMenu] = React.useState(false)\n\n  const hasDrillDown = kpi.drillDimensions && kpi.drillDimensions.length > 0\n  const numericValue = typeof kpi.value === \"number\" ? kpi.value : parseFloat(String(kpi.value))\n  const numericTarget = typeof kpi.target === \"number\" ? kpi.target : kpi.target ? parseFloat(String(kpi.target)) : undefined\n\n  const handleRefresh = async () => {\n    if (!onRefresh) return\n    setIsRefreshing(true)\n    try {\n      await onRefresh()\n    } finally {\n      setIsRefreshing(false)\n    }\n  }\n\n  return (\n    <Card\n      className={cn(\n        \"transition-all\",\n        hasDrillDown && \"cursor-pointer hover:shadow-lg hover:border-primary/50\",\n        kpi.isLoading && \"opacity-50\"\n      )}\n      onClick={() => {\n        if (hasDrillDown && kpi.drillDimensions!.length === 1) {\n          onDrillDown?.(kpi.drillDimensions![0])\n        } else if (hasDrillDown) {\n          setShowDrillMenu(true)\n        }\n      }}\n    >\n      <CardHeader className=\"pb-2\">\n        <div className=\"flex items-start justify-between\">\n          <div className=\"flex-1 min-w-0\">\n            <CardTitle className=\"text-sm font-medium text-muted-foreground\">\n              {kpi.name}\n            </CardTitle>\n            {kpi.description && (\n              <CardDescription className=\"text-xs mt-0.5 line-clamp-1\">\n                {kpi.description}\n              </CardDescription>\n            )}\n          </div>\n          <div className=\"flex items-center gap-1\">\n            <StatusBadge status={kpi.status} />\n            <DropdownMenu>\n              <DropdownMenuTrigger onClick={(e) => e.stopPropagation()}>\n                <Button variant=\"ghost\" size=\"sm\" className=\"h-6 w-6 p-0\">\n                  <MoreVertical className=\"h-3 w-3\" />\n                </Button>\n              </DropdownMenuTrigger>\n              <DropdownMenuContent align=\"end\">\n                {onRefresh && (\n                  <DropdownMenuItem onClick={handleRefresh}>\n                    <RefreshCw className={cn(\"mr-2 h-4 w-4\", isRefreshing && \"animate-spin\")} />\n                    Refresh\n                  </DropdownMenuItem>\n                )}\n                {onExport && (\n                  <>\n                    <DropdownMenuItem onClick={() => onExport(\"csv\")}>\n                      <Download className=\"mr-2 h-4 w-4\" />\n                      Export CSV\n                    </DropdownMenuItem>\n                    <DropdownMenuItem onClick={() => onExport(\"excel\")}>\n                      <Download className=\"mr-2 h-4 w-4\" />\n                      Export Excel\n                    </DropdownMenuItem>\n                  </>\n                )}\n              </DropdownMenuContent>\n            </DropdownMenu>\n          </div>\n        </div>\n      </CardHeader>\n      <CardContent>\n        <div className=\"flex items-end justify-between\">\n          <div>\n            <div className=\"flex items-baseline gap-2\">\n              <span className=\"text-2xl font-bold\">\n                {kpi.isLoading ? (\n                  <Loader2 className=\"h-6 w-6 animate-spin\" />\n                ) : (\n                  kpi.formattedValue\n                )}\n              </span>\n              {kpi.unit && (\n                <span className=\"text-sm text-muted-foreground\">{kpi.unit}</span>\n              )}\n            </div>\n            <div className=\"mt-1 flex items-center gap-2\">\n              <TrendIndicator trend={kpi.trend} />\n              {kpi.formattedTarget && (\n                <span className=\"text-xs text-muted-foreground\">\n                  Target: {kpi.formattedTarget}\n                </span>\n              )}\n            </div>\n          </div>\n          {kpi.sparkline && <MiniSparkline data={kpi.sparkline} />}\n        </div>\n\n        {/* Progress to Target */}\n        {!isNaN(numericValue) && numericTarget && (\n          <div className=\"mt-3\">\n            <ProgressToTarget value={numericValue} target={numericTarget} />\n          </div>\n        )}\n\n        {/* AI Insight */}\n        {showAIInsights && kpi.aiInsight && (\n          <div className=\"mt-3 rounded-lg bg-primary/5 p-2 text-xs\">\n            <div className=\"flex items-start gap-2\">\n              <Sparkles className=\"h-3 w-3 text-primary shrink-0 mt-0.5\" />\n              <p className=\"text-muted-foreground\">{kpi.aiInsight}</p>\n            </div>\n          </div>\n        )}\n\n        {/* Drill Down Indicator */}\n        {hasDrillDown && (\n          <div className=\"mt-3 flex items-center justify-between border-t pt-2\">\n            <span className=\"text-xs text-muted-foreground\">\n              Drill by: {kpi.drillDimensions!.map((d) => d.label).join(\", \")}\n            </span>\n            <ChevronRight className=\"h-4 w-4 text-muted-foreground\" />\n          </div>\n        )}\n\n        {/* Drill Menu for multiple dimensions */}\n        {showDrillMenu && hasDrillDown && kpi.drillDimensions!.length > 1 && (\n          <div className=\"mt-2 space-y-1\">\n            {kpi.drillDimensions!.map((dimension) => (\n              <Button\n                key={dimension.id}\n                variant=\"outline\"\n                size=\"sm\"\n                className=\"w-full justify-start\"\n                onClick={(e) => {\n                  e.stopPropagation()\n                  onDrillDown?.(dimension)\n                  setShowDrillMenu(false)\n                }}\n              >\n                <ChevronDown className=\"mr-2 h-3 w-3\" />\n                By {dimension.label}\n              </Button>\n            ))}\n          </div>\n        )}\n\n        {/* Last Updated */}\n        {kpi.lastUpdated && (\n          <div className=\"mt-2 text-xs text-muted-foreground\">\n            Updated: {new Date(kpi.lastUpdated).toLocaleString()}\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  )\n}\n\n// ============================================================================\n// Main Component\n// ============================================================================\n\nexport function DrilldownDashboard({\n  kpis,\n  onDrillDown,\n  onExport,\n  onRefresh,\n  drillPath = [],\n  title = \"Dashboard\",\n  description,\n  showAIInsights = true,\n  columns = 4,\n  className,\n}: DrilldownDashboardProps) {\n  const [currentKPIs, setCurrentKPIs] = React.useState<KPIData[]>(kpis)\n  const [localDrillPath, setLocalDrillPath] = React.useState<DrilldownLevel[]>(drillPath)\n  const [isLoading, setIsLoading] = React.useState(false)\n\n  React.useEffect(() => {\n    setCurrentKPIs(kpis)\n  }, [kpis])\n\n  const handleDrillDown = async (kpiId: string, dimension: DrillDimension) => {\n    if (!onDrillDown) return\n\n    setIsLoading(true)\n    try {\n      const newKPIs = await onDrillDown(kpiId, dimension, localDrillPath)\n      setCurrentKPIs(newKPIs)\n      setLocalDrillPath((prev) => [\n        ...prev,\n        {\n          kpiId,\n          dimensionId: dimension.id,\n          dimensionValue: dimension.label,\n          label: `${kpis.find((k) => k.id === kpiId)?.name || kpiId} by ${dimension.label}`,\n        },\n      ])\n    } finally {\n      setIsLoading(false)\n    }\n  }\n\n  const handleNavigateBack = (index: number) => {\n    if (index === -1) {\n      // Go to root\n      setLocalDrillPath([])\n      setCurrentKPIs(kpis)\n    } else {\n      // Go to specific level\n      setLocalDrillPath((prev) => prev.slice(0, index + 1))\n      // Would need to reload data for this level - simplified for now\n    }\n  }\n\n  const handleRefreshAll = async () => {\n    if (!onRefresh) return\n    setIsLoading(true)\n    try {\n      await onRefresh()\n    } finally {\n      setIsLoading(false)\n    }\n  }\n\n  const gridCols = {\n    2: \"md:grid-cols-2\",\n    3: \"md:grid-cols-2 lg:grid-cols-3\",\n    4: \"md:grid-cols-2 lg:grid-cols-4\",\n  }\n\n  return (\n    <Card className={className}>\n      <CardHeader>\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <CardTitle className=\"flex items-center gap-2\">\n              {localDrillPath.length > 0 && (\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  className=\"h-8 w-8 p-0\"\n                  onClick={() => handleNavigateBack(-1)}\n                >\n                  <ArrowLeft className=\"h-4 w-4\" />\n                </Button>\n              )}\n              {title}\n            </CardTitle>\n            {description && <CardDescription>{description}</CardDescription>}\n          </div>\n          <div className=\"flex items-center gap-2\">\n            {onRefresh && (\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={handleRefreshAll}\n                disabled={isLoading}\n              >\n                <RefreshCw className={cn(\"mr-2 h-4 w-4\", isLoading && \"animate-spin\")} />\n                Refresh All\n              </Button>\n            )}\n          </div>\n        </div>\n\n        {/* Breadcrumb */}\n        {localDrillPath.length > 0 && (\n          <Breadcrumb className=\"mt-2\">\n            <BreadcrumbList>\n              <BreadcrumbItem>\n                <BreadcrumbLink\n                  className=\"cursor-pointer\"\n                  onClick={() => handleNavigateBack(-1)}\n                >\n                  Overview\n                </BreadcrumbLink>\n              </BreadcrumbItem>\n              {localDrillPath.map((level, index) => (\n                <React.Fragment key={index}>\n                  <BreadcrumbSeparator />\n                  <BreadcrumbItem>\n                    {index === localDrillPath.length - 1 ? (\n                      <BreadcrumbPage>{level.label}</BreadcrumbPage>\n                    ) : (\n                      <BreadcrumbLink\n                        className=\"cursor-pointer\"\n                        onClick={() => handleNavigateBack(index)}\n                      >\n                        {level.label}\n                      </BreadcrumbLink>\n                    )}\n                  </BreadcrumbItem>\n                </React.Fragment>\n              ))}\n            </BreadcrumbList>\n          </Breadcrumb>\n        )}\n      </CardHeader>\n      <CardContent>\n        {isLoading ? (\n          <div className=\"flex items-center justify-center py-12\">\n            <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n          </div>\n        ) : currentKPIs.length === 0 ? (\n          <div className=\"flex flex-col items-center justify-center py-12 text-center\">\n            <Target className=\"h-12 w-12 text-muted-foreground/50\" />\n            <h3 className=\"mt-4 font-semibold\">No KPIs configured</h3>\n            <p className=\"text-sm text-muted-foreground\">\n              Add KPIs to display metrics on this dashboard\n            </p>\n          </div>\n        ) : (\n          <div className={cn(\"grid gap-4\", gridCols[columns])}>\n            {currentKPIs.map((kpi) => (\n              <KPICard\n                key={kpi.id}\n                kpi={kpi}\n                onDrillDown={(dimension) => handleDrillDown(kpi.id, dimension)}\n                onExport={onExport ? (format) => onExport(kpi.id, format) : undefined}\n                onRefresh={onRefresh ? () => onRefresh(kpi.id) : undefined}\n                showAIInsights={showAIInsights}\n              />\n            ))}\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  )\n}\n\n// ============================================================================\n// Exports\n// ============================================================================\n\nexport type { KPIStatus, DrillDimension, SparklineData, KPIData, DrilldownLevel }\n// TrendDirection is re-exported from blocks/types.ts\n"
    }
  ]
}