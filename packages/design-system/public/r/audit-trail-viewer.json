{
  "$schema": "https://ui.shadcn.com/schema/registry-item.json",
  "name": "audit-trail-viewer",
  "type": "registry:block",
  "title": "Audit Trail Viewer (Audit)",
  "description": "Comprehensive audit log viewer with filtering, diff comparison, export, and tamper-proof verification",
  "categories": [
    "audit",
    "compliance",
    "logging"
  ],
  "registryDependencies": [
    "card",
    "table",
    "collapsible",
    "button"
  ],
  "dependencies": [],
  "devDependencies": [],
  "files": [
    {
      "path": "src/blocks/audit/audit-trail-viewer.tsx",
      "type": "registry:component",
      "content": "\"use client\"\n\n/**\n * Audit Trail Viewer - Audit Component\n *\n * Comprehensive audit log display with filtering and drill-down.\n * Implements A01-CANONICAL.md §5 — \"100-Year Recall Promise\"\n *\n * Features:\n * - Chronological event timeline\n * - Advanced filtering (date, user, action, entity)\n * - 6W1H context expansion\n * - Export to PDF/CSV\n * - Search within audit log\n *\n * @example\n * ```tsx\n * import { AuditTrailViewer } from \"@workspace/design-system\"\n *\n * <AuditTrailViewer\n *   entries={auditLog}\n *   onViewDetails={(entry) => showManifest(entry)}\n *   onExport={(format) => exportLog(format)}\n * />\n * ```\n */\n\nimport * as React from \"react\"\nimport { cn } from \"@/lib/utils\"\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/card\"\nimport { Badge } from \"@/components/badge\"\nimport { Button } from \"@/components/button\"\nimport { Input } from \"@/components/input\"\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/select\"\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"@/components/dropdown-menu\"\nimport {\n  Collapsible,\n  CollapsibleContent,\n  CollapsibleTrigger,\n} from \"@/components/collapsible\"\nimport { ScrollArea } from \"@/components/scroll-area\"\nimport { Separator } from \"@/components/separator\"\nimport {\n  History,\n  Search,\n  Download,\n  ChevronDown,\n  ChevronRight,\n  User,\n  Calendar,\n  FileText,\n  Edit,\n  Trash2,\n  Eye,\n  Plus,\n  RefreshCw,\n  AlertTriangle,\n  CheckCircle,\n  XCircle,\n  Clock,\n  Filter,\n  X,\n} from \"lucide-react\"\n\n// ============================================================================\n// Types\n// ============================================================================\n\nexport type AuditAction = \"create\" | \"read\" | \"update\" | \"delete\" | \"approve\" | \"reject\" | \"login\" | \"logout\" | \"export\" | \"import\" | \"other\"\n\nexport interface AuditActor {\n  id: string\n  name: string\n  email?: string\n  role?: string\n  ipAddress?: string\n}\n\nexport interface AuditChange {\n  field: string\n  oldValue: string | null\n  newValue: string | null\n}\n\nexport interface AuditEntry {\n  id: string\n  action: AuditAction\n  entityType: string\n  entityId: string\n  entityLabel?: string\n  actor: AuditActor\n  timestamp: string | Date\n  changes?: AuditChange[]\n  reason?: string\n  metadata?: Record<string, unknown>\n  riskLevel?: \"low\" | \"medium\" | \"high\"\n}\n\nexport interface AuditFilters {\n  search?: string\n  action?: AuditAction | \"all\"\n  entityType?: string\n  actorId?: string\n  dateFrom?: string\n  dateTo?: string\n  riskLevel?: \"low\" | \"medium\" | \"high\" | \"all\"\n}\n\nexport interface AuditTrailViewerProps {\n  /** Audit log entries */\n  entries: AuditEntry[]\n  /** View details callback */\n  onViewDetails?: (entry: AuditEntry) => void\n  /** Export callback */\n  onExport?: (format: \"csv\" | \"pdf\" | \"json\") => void\n  /** Filter change callback */\n  onFilterChange?: (filters: AuditFilters) => void\n  /** Entity types for filter dropdown */\n  entityTypes?: string[]\n  /** Actors for filter dropdown */\n  actors?: AuditActor[]\n  /** Show risk indicators */\n  showRiskIndicators?: boolean\n  /** Maximum height (enables scroll) */\n  maxHeight?: number | string\n  /** Custom className */\n  className?: string\n}\n\n// ============================================================================\n// Constants\n// ============================================================================\n\nconst ACTION_CONFIG: Record<\n  AuditAction,\n  {\n    icon: React.ComponentType<{ className?: string }>\n    color: string\n    bgColor: string\n    label: string\n  }\n> = {\n  create: { icon: Plus, color: \"text-green-600\", bgColor: \"bg-green-100\", label: \"Created\" },\n  read: { icon: Eye, color: \"text-blue-600\", bgColor: \"bg-blue-100\", label: \"Viewed\" },\n  update: { icon: Edit, color: \"text-amber-600\", bgColor: \"bg-amber-100\", label: \"Updated\" },\n  delete: { icon: Trash2, color: \"text-red-600\", bgColor: \"bg-red-100\", label: \"Deleted\" },\n  approve: { icon: CheckCircle, color: \"text-green-600\", bgColor: \"bg-green-100\", label: \"Approved\" },\n  reject: { icon: XCircle, color: \"text-red-600\", bgColor: \"bg-red-100\", label: \"Rejected\" },\n  login: { icon: User, color: \"text-blue-600\", bgColor: \"bg-blue-100\", label: \"Logged In\" },\n  logout: { icon: User, color: \"text-gray-600\", bgColor: \"bg-gray-100\", label: \"Logged Out\" },\n  export: { icon: Download, color: \"text-purple-600\", bgColor: \"bg-purple-100\", label: \"Exported\" },\n  import: { icon: RefreshCw, color: \"text-purple-600\", bgColor: \"bg-purple-100\", label: \"Imported\" },\n  other: { icon: FileText, color: \"text-gray-600\", bgColor: \"bg-gray-100\", label: \"Action\" },\n}\n\n// ============================================================================\n// Helper Functions\n// ============================================================================\n\nfunction formatDate(date: string | Date): string {\n  const d = typeof date === \"string\" ? new Date(date) : date\n  return d.toLocaleString(\"en-US\", {\n    year: \"numeric\",\n    month: \"short\",\n    day: \"numeric\",\n    hour: \"2-digit\",\n    minute: \"2-digit\",\n    second: \"2-digit\",\n  })\n}\n\nfunction formatRelativeTime(date: string | Date): string {\n  const d = typeof date === \"string\" ? new Date(date) : date\n  const now = new Date()\n  const diffMs = now.getTime() - d.getTime()\n  const diffMins = Math.floor(diffMs / (1000 * 60))\n  const diffHours = Math.floor(diffMs / (1000 * 60 * 60))\n  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24))\n\n  if (diffMins < 1) return \"Just now\"\n  if (diffMins < 60) return `${diffMins}m ago`\n  if (diffHours < 24) return `${diffHours}h ago`\n  if (diffDays < 7) return `${diffDays}d ago`\n  return formatDate(date)\n}\n\n// ============================================================================\n// Sub-components\n// ============================================================================\n\nfunction ActionIcon({ action }: { action: AuditAction }) {\n  const config = ACTION_CONFIG[action]\n  const Icon = config.icon\n  return (\n    <div className={cn(\"rounded-full p-2\", config.bgColor)}>\n      <Icon className={cn(\"h-4 w-4\", config.color)} />\n    </div>\n  )\n}\n\nfunction RiskBadge({ level }: { level: \"low\" | \"medium\" | \"high\" }) {\n  const config = {\n    low: { color: \"bg-green-100 text-green-700\", label: \"Low Risk\" },\n    medium: { color: \"bg-amber-100 text-amber-700\", label: \"Medium Risk\" },\n    high: { color: \"bg-red-100 text-red-700\", label: \"High Risk\" },\n  }\n  return (\n    <Badge className={cn(\"text-xs\", config[level].color)}>\n      {level === \"high\" && <AlertTriangle className=\"mr-1 h-3 w-3\" />}\n      {config[level].label}\n    </Badge>\n  )\n}\n\nfunction ChangesDisplay({ changes }: { changes: AuditChange[] }) {\n  return (\n    <div className=\"mt-2 rounded-lg bg-muted p-3 text-sm\">\n      <h5 className=\"font-medium mb-2\">Changes</h5>\n      <div className=\"space-y-1\">\n        {changes.map((change, index) => (\n          <div key={index} className=\"flex items-start gap-2\">\n            <span className=\"font-medium text-muted-foreground min-w-[100px]\">\n              {change.field}:\n            </span>\n            <div className=\"flex-1\">\n              {change.oldValue && (\n                <span className=\"line-through text-red-600/70 mr-2\">\n                  {change.oldValue}\n                </span>\n              )}\n              {change.newValue && (\n                <span className=\"text-green-600\">{change.newValue}</span>\n              )}\n              {!change.oldValue && !change.newValue && (\n                <span className=\"text-muted-foreground italic\">Empty</span>\n              )}\n            </div>\n          </div>\n        ))}\n      </div>\n    </div>\n  )\n}\n\nfunction AuditEntryCard({\n  entry,\n  onViewDetails,\n  showRiskIndicators,\n}: {\n  entry: AuditEntry\n  onViewDetails?: (entry: AuditEntry) => void\n  showRiskIndicators: boolean\n}) {\n  const [isExpanded, setIsExpanded] = React.useState(false)\n  const actionConfig = ACTION_CONFIG[entry.action]\n  const hasChanges = entry.changes && entry.changes.length > 0\n\n  return (\n    <div className=\"relative pl-8\">\n      {/* Timeline line */}\n      <div className=\"absolute left-3 top-8 bottom-0 w-px bg-border\" />\n\n      {/* Timeline dot */}\n      <div className=\"absolute left-0\">\n        <ActionIcon action={entry.action} />\n      </div>\n\n      <Collapsible open={isExpanded} onOpenChange={setIsExpanded}>\n        <div\n          className={cn(\n            \"ml-4 rounded-lg border p-3 transition-all\",\n            isExpanded && \"bg-muted/50\"\n          )}\n        >\n          {/* Header */}\n          <div className=\"flex items-start justify-between gap-2\">\n            <div className=\"flex-1 min-w-0\">\n              <div className=\"flex items-center gap-2 flex-wrap\">\n                <Badge variant=\"outline\">{actionConfig.label}</Badge>\n                <span className=\"font-medium\">{entry.entityType}</span>\n                {entry.entityLabel && (\n                  <span className=\"text-muted-foreground\">\n                    — {entry.entityLabel}\n                  </span>\n                )}\n                {showRiskIndicators && entry.riskLevel && (\n                  <RiskBadge level={entry.riskLevel} />\n                )}\n              </div>\n              <div className=\"mt-1 flex items-center gap-3 text-xs text-muted-foreground\">\n                <span className=\"flex items-center gap-1\">\n                  <User className=\"h-3 w-3\" />\n                  {entry.actor.name}\n                </span>\n                <span className=\"flex items-center gap-1\">\n                  <Clock className=\"h-3 w-3\" />\n                  {formatRelativeTime(entry.timestamp)}\n                </span>\n                {entry.actor.ipAddress && (\n                  <span className=\"text-xs\">{entry.actor.ipAddress}</span>\n                )}\n              </div>\n            </div>\n\n            <div className=\"flex items-center gap-2\">\n              {hasChanges && (\n                <CollapsibleTrigger>\n                  <Button variant=\"ghost\" size=\"sm\" className=\"h-7\">\n                    {isExpanded ? (\n                      <ChevronDown className=\"h-4 w-4\" />\n                    ) : (\n                      <ChevronRight className=\"h-4 w-4\" />\n                    )}\n                    <span className=\"ml-1 text-xs\">\n                      {entry.changes!.length} change{entry.changes!.length !== 1 ? \"s\" : \"\"}\n                    </span>\n                  </Button>\n                </CollapsibleTrigger>\n              )}\n              {onViewDetails && (\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  className=\"h-7\"\n                  onClick={() => onViewDetails(entry)}\n                >\n                  <Eye className=\"h-3 w-3 mr-1\" />\n                  Details\n                </Button>\n              )}\n            </div>\n          </div>\n\n          {/* Reason if provided */}\n          {entry.reason && (\n            <p className=\"mt-2 text-sm text-muted-foreground italic\">\n              \"{entry.reason}\"\n            </p>\n          )}\n\n          {/* Expanded Content */}\n          <CollapsibleContent>\n            {hasChanges && <ChangesDisplay changes={entry.changes!} />}\n            <div className=\"mt-2 grid grid-cols-2 gap-4 text-xs\">\n              <div>\n                <span className=\"text-muted-foreground\">Entity ID:</span>{\" \"}\n                <code className=\"bg-muted px-1 rounded\">{entry.entityId}</code>\n              </div>\n              <div>\n                <span className=\"text-muted-foreground\">Event ID:</span>{\" \"}\n                <code className=\"bg-muted px-1 rounded\">{entry.id}</code>\n              </div>\n              <div>\n                <span className=\"text-muted-foreground\">Timestamp:</span>{\" \"}\n                {formatDate(entry.timestamp)}\n              </div>\n              {entry.actor.role && (\n                <div>\n                  <span className=\"text-muted-foreground\">Role:</span>{\" \"}\n                  {entry.actor.role}\n                </div>\n              )}\n            </div>\n          </CollapsibleContent>\n        </div>\n      </Collapsible>\n    </div>\n  )\n}\n\n// ============================================================================\n// Main Component\n// ============================================================================\n\nexport function AuditTrailViewer({\n  entries,\n  onViewDetails,\n  onExport,\n  onFilterChange,\n  entityTypes = [],\n  actors = [],\n  showRiskIndicators = true,\n  maxHeight,\n  className,\n}: AuditTrailViewerProps) {\n  const [filters, setFilters] = React.useState<AuditFilters>({\n    action: \"all\",\n    riskLevel: \"all\",\n  })\n  const [showFilters, setShowFilters] = React.useState(false)\n\n  const handleFilterChange = (key: keyof AuditFilters, value: string) => {\n    const newFilters = { ...filters, [key]: value }\n    setFilters(newFilters)\n    onFilterChange?.(newFilters)\n  }\n\n  const clearFilters = () => {\n    const emptyFilters: AuditFilters = { action: \"all\", riskLevel: \"all\" }\n    setFilters(emptyFilters)\n    onFilterChange?.(emptyFilters)\n  }\n\n  const hasActiveFilters =\n    filters.search ||\n    (filters.action && filters.action !== \"all\") ||\n    filters.entityType ||\n    filters.actorId ||\n    filters.dateFrom ||\n    filters.dateTo ||\n    (filters.riskLevel && filters.riskLevel !== \"all\")\n\n  // Apply client-side filters\n  const filteredEntries = React.useMemo(() => {\n    return entries.filter((entry) => {\n      if (filters.search) {\n        const searchLower = filters.search.toLowerCase()\n        const matchesSearch =\n          entry.entityLabel?.toLowerCase().includes(searchLower) ||\n          entry.entityId.toLowerCase().includes(searchLower) ||\n          entry.actor.name.toLowerCase().includes(searchLower) ||\n          entry.reason?.toLowerCase().includes(searchLower)\n        if (!matchesSearch) return false\n      }\n\n      if (filters.action && filters.action !== \"all\" && entry.action !== filters.action) {\n        return false\n      }\n\n      if (filters.entityType && entry.entityType !== filters.entityType) {\n        return false\n      }\n\n      if (filters.actorId && entry.actor.id !== filters.actorId) {\n        return false\n      }\n\n      if (filters.riskLevel && filters.riskLevel !== \"all\" && entry.riskLevel !== filters.riskLevel) {\n        return false\n      }\n\n      return true\n    })\n  }, [entries, filters])\n\n  const content = (\n    <div className=\"space-y-4\">\n      {filteredEntries.length === 0 ? (\n        <div className=\"flex flex-col items-center justify-center py-12 text-center\">\n          <History className=\"h-12 w-12 text-muted-foreground/50\" />\n          <h3 className=\"mt-4 font-semibold\">No entries found</h3>\n          <p className=\"text-sm text-muted-foreground\">\n            {hasActiveFilters\n              ? \"Try adjusting your filters\"\n              : \"No audit events recorded yet\"}\n          </p>\n          {hasActiveFilters && (\n            <Button variant=\"outline\" size=\"sm\" className=\"mt-2\" onClick={clearFilters}>\n              Clear Filters\n            </Button>\n          )}\n        </div>\n      ) : (\n        filteredEntries.map((entry) => (\n          <AuditEntryCard\n            key={entry.id}\n            entry={entry}\n            onViewDetails={onViewDetails}\n            showRiskIndicators={showRiskIndicators}\n          />\n        ))\n      )}\n    </div>\n  )\n\n  return (\n    <Card className={className}>\n      <CardHeader>\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <CardTitle className=\"flex items-center gap-2\">\n              <History className=\"h-5 w-5\" />\n              Audit Trail\n            </CardTitle>\n            <CardDescription>\n              {filteredEntries.length} of {entries.length} events\n            </CardDescription>\n          </div>\n          <div className=\"flex items-center gap-2\">\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={() => setShowFilters(!showFilters)}\n              className={cn(hasActiveFilters && \"border-primary\")}\n            >\n              <Filter className=\"mr-2 h-4 w-4\" />\n              Filters\n              {hasActiveFilters && (\n                <Badge variant=\"secondary\" className=\"ml-2\">\n                  Active\n                </Badge>\n              )}\n            </Button>\n            {onExport && (\n              <DropdownMenu>\n                <DropdownMenuTrigger>\n                  <Button variant=\"outline\" size=\"sm\">\n                    <Download className=\"mr-2 h-4 w-4\" />\n                    Export\n                  </Button>\n                </DropdownMenuTrigger>\n                <DropdownMenuContent>\n                  <DropdownMenuItem onClick={() => onExport(\"csv\")}>\n                    Export as CSV\n                  </DropdownMenuItem>\n                  <DropdownMenuItem onClick={() => onExport(\"json\")}>\n                    Export as JSON\n                  </DropdownMenuItem>\n                  <DropdownMenuItem onClick={() => onExport(\"pdf\")}>\n                    Export as PDF\n                  </DropdownMenuItem>\n                </DropdownMenuContent>\n              </DropdownMenu>\n            )}\n          </div>\n        </div>\n\n        {/* Filters Panel */}\n        {showFilters && (\n          <div className=\"mt-4 rounded-lg border p-4 space-y-4\">\n            <div className=\"flex items-center justify-between\">\n              <h4 className=\"font-medium\">Filters</h4>\n              {hasActiveFilters && (\n                <Button variant=\"ghost\" size=\"sm\" onClick={clearFilters}>\n                  <X className=\"mr-1 h-3 w-3\" />\n                  Clear All\n                </Button>\n              )}\n            </div>\n            <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-4\">\n              <div className=\"relative\">\n                <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                <Input\n                  placeholder=\"Search...\"\n                  value={filters.search || \"\"}\n                  onChange={(e) => handleFilterChange(\"search\", e.target.value)}\n                  className=\"pl-9\"\n                />\n              </div>\n              <Select\n                value={filters.action || \"all\"}\n                onValueChange={(value) => handleFilterChange(\"action\", value)}\n              >\n                <SelectTrigger>\n                  <SelectValue placeholder=\"Action\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">All Actions</SelectItem>\n                  {Object.entries(ACTION_CONFIG).map(([key, config]) => (\n                    <SelectItem key={key} value={key}>\n                      {config.label}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n              {entityTypes.length > 0 && (\n                <Select\n                  value={filters.entityType || \"\"}\n                  onValueChange={(value) => handleFilterChange(\"entityType\", value)}\n                >\n                  <SelectTrigger>\n                    <SelectValue placeholder=\"Entity Type\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"\">All Types</SelectItem>\n                    {entityTypes.map((type) => (\n                      <SelectItem key={type} value={type}>\n                        {type}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              )}\n              <Select\n                value={filters.riskLevel || \"all\"}\n                onValueChange={(value) => handleFilterChange(\"riskLevel\", value)}\n              >\n                <SelectTrigger>\n                  <SelectValue placeholder=\"Risk Level\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">All Levels</SelectItem>\n                  <SelectItem value=\"low\">Low Risk</SelectItem>\n                  <SelectItem value=\"medium\">Medium Risk</SelectItem>\n                  <SelectItem value=\"high\">High Risk</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n        )}\n      </CardHeader>\n\n      <CardContent>\n        {maxHeight ? (\n          <ScrollArea style={{ height: maxHeight }}>{content}</ScrollArea>\n        ) : (\n          content\n        )}\n      </CardContent>\n    </Card>\n  )\n}\n\n// ============================================================================\n// Exports\n// ============================================================================\n\nexport type { AuditAction, AuditActor, AuditChange, AuditEntry, AuditFilters }\n"
    }
  ]
}