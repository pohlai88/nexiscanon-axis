{
  "$schema": "https://ui.shadcn.com/schema/registry-item.json",
  "name": "reconciliation-widget",
  "type": "registry:block",
  "title": "Reconciliation Widget (ERP)",
  "description": "Subledger to GL reconciliation with difference highlighting, auto-match suggestions, and adjustment posting",
  "categories": [
    "erp",
    "accounting",
    "reconciliation"
  ],
  "registryDependencies": [
    "card",
    "table",
    "button",
    "tooltip"
  ],
  "dependencies": [],
  "devDependencies": [],
  "files": [
    {
      "path": "src/blocks/erp/reconciliation-widget.tsx",
      "type": "registry:component",
      "content": "\"use client\"\n\n/**\n * Reconciliation Widget - ERP Domain Component\n *\n * Show subledger ↔ GL reconciliation gaps.\n * Implements A01-CANONICAL.md §3 — Three Pillars (Money)\n *\n * Features:\n * - Side-by-side comparison\n * - Difference highlighting\n * - Auto-match suggestions\n * - Drill-down to transactions\n * - Reconciliation actions\n *\n * @example\n * ```tsx\n * import { ReconciliationWidget } from \"@workspace/design-system\"\n *\n * <ReconciliationWidget\n *   subledger={arBalances}\n *   generalLedger={glBalances}\n *   onReconcile={(items) => markReconciled(items)}\n *   onDrillDown={(item) => viewTransactions(item)}\n * />\n * ```\n */\n\nimport * as React from \"react\"\nimport { cn } from \"@/lib/utils\"\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription, CardFooter } from \"@/components/card\"\nimport { Badge } from \"@/components/badge\"\nimport { Button } from \"@/components/button\"\nimport { Progress } from \"@/components/progress\"\nimport { Checkbox } from \"@/components/checkbox\"\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/table\"\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/tooltip\"\nimport {\n  AlertTriangle,\n  CheckCircle,\n  ArrowLeftRight,\n  Sparkles,\n  ExternalLink,\n  RefreshCw,\n  Download,\n  Loader2,\n  XCircle,\n  AlertCircle,\n  ArrowRight,\n  Zap,\n} from \"lucide-react\"\n\n// ============================================================================\n// Types\n// ============================================================================\n\nexport type ReconciliationStatus = \"matched\" | \"unmatched\" | \"partial\" | \"pending\"\n\nexport interface ReconciliationItem {\n  id: string\n  reference: string\n  description: string\n  subledgerAmount: number\n  glAmount: number\n  difference: number\n  status: ReconciliationStatus\n  subledgerDate?: string | Date\n  glDate?: string | Date\n  suggestedMatch?: {\n    itemId: string\n    confidence: number\n    reason: string\n  }\n  metadata?: Record<string, unknown>\n}\n\nexport interface ReconciliationSummary {\n  totalItems: number\n  matchedCount: number\n  unmatchedCount: number\n  partialCount: number\n  subledgerTotal: number\n  glTotal: number\n  totalDifference: number\n  matchPercentage: number\n}\n\nexport interface ReconciliationWidgetProps {\n  /** Reconciliation items */\n  items: ReconciliationItem[]\n  /** Subledger name */\n  subledgerName?: string\n  /** GL account name */\n  glAccountName?: string\n  /** Reconcile callback */\n  onReconcile?: (itemIds: string[]) => Promise<void>\n  /** Drill-down callback */\n  onDrillDown?: (item: ReconciliationItem, source: \"subledger\" | \"gl\") => void\n  /** Auto-match callback */\n  onAutoMatch?: () => Promise<void>\n  /** Export callback */\n  onExport?: (format: \"csv\" | \"excel\") => void\n  /** Refresh callback */\n  onRefresh?: () => Promise<void>\n  /** Currency symbol */\n  currency?: string\n  /** Show suggested matches */\n  showSuggestions?: boolean\n  /** Custom className */\n  className?: string\n}\n\n// ============================================================================\n// Helpers\n// ============================================================================\n\nfunction formatCurrency(amount: number, currency: string = \"$\"): string {\n  const absAmount = Math.abs(amount)\n  const formatted = `${currency}${absAmount.toLocaleString(\"en-US\", {\n    minimumFractionDigits: 2,\n    maximumFractionDigits: 2,\n  })}`\n  return amount < 0 ? `(${formatted})` : formatted\n}\n\nfunction calculateSummary(items: ReconciliationItem[]): ReconciliationSummary {\n  const matchedCount = items.filter((i) => i.status === \"matched\").length\n  const unmatchedCount = items.filter((i) => i.status === \"unmatched\").length\n  const partialCount = items.filter((i) => i.status === \"partial\").length\n\n  const subledgerTotal = items.reduce((sum, i) => sum + i.subledgerAmount, 0)\n  const glTotal = items.reduce((sum, i) => sum + i.glAmount, 0)\n\n  return {\n    totalItems: items.length,\n    matchedCount,\n    unmatchedCount,\n    partialCount,\n    subledgerTotal,\n    glTotal,\n    totalDifference: Math.abs(subledgerTotal - glTotal),\n    matchPercentage: items.length > 0 ? (matchedCount / items.length) * 100 : 100,\n  }\n}\n\n// ============================================================================\n// Status Badge\n// ============================================================================\n\nfunction StatusBadge({ status }: { status: ReconciliationStatus }) {\n  const config = {\n    matched: { icon: CheckCircle, color: \"bg-green-100 text-green-700\", label: \"Matched\" },\n    unmatched: { icon: XCircle, color: \"bg-red-100 text-red-700\", label: \"Unmatched\" },\n    partial: { icon: AlertCircle, color: \"bg-amber-100 text-amber-700\", label: \"Partial\" },\n    pending: { icon: RefreshCw, color: \"bg-gray-100 text-gray-700\", label: \"Pending\" },\n  }\n\n  const c = config[status]\n  const Icon = c.icon\n\n  return (\n    <Badge className={cn(\"gap-1\", c.color)}>\n      <Icon className=\"h-3 w-3\" />\n      {c.label}\n    </Badge>\n  )\n}\n\n// ============================================================================\n// Summary Card\n// ============================================================================\n\nfunction ReconciliationSummaryCard({\n  summary,\n  subledgerName,\n  glAccountName,\n  currency,\n}: {\n  summary: ReconciliationSummary\n  subledgerName: string\n  glAccountName: string\n  currency: string\n}) {\n  const isReconciled = summary.totalDifference < 0.01\n\n  return (\n    <div className=\"space-y-4\">\n      {/* Progress */}\n      <div className=\"space-y-2\">\n        <div className=\"flex items-center justify-between text-sm\">\n          <span className=\"text-muted-foreground\">Reconciliation Progress</span>\n          <span className=\"font-medium\">{summary.matchPercentage.toFixed(0)}%</span>\n        </div>\n        <Progress value={summary.matchPercentage} className=\"h-2\" />\n      </div>\n\n      {/* Comparison */}\n      <div className=\"grid gap-4 md:grid-cols-3\">\n        <Card className=\"p-4\">\n          <p className=\"text-xs text-muted-foreground\">{subledgerName}</p>\n          <p className=\"text-xl font-bold\">{formatCurrency(summary.subledgerTotal, currency)}</p>\n        </Card>\n        <Card className=\"p-4 flex items-center justify-center\">\n          <div className=\"flex items-center gap-2\">\n            <ArrowLeftRight className=\"h-5 w-5 text-muted-foreground\" />\n            <div\n              className={cn(\n                \"text-lg font-bold\",\n                isReconciled ? \"text-green-600\" : \"text-red-600\"\n              )}\n            >\n              {isReconciled ? \"✓ Balanced\" : formatCurrency(summary.totalDifference, currency)}\n            </div>\n          </div>\n        </Card>\n        <Card className=\"p-4\">\n          <p className=\"text-xs text-muted-foreground\">{glAccountName}</p>\n          <p className=\"text-xl font-bold\">{formatCurrency(summary.glTotal, currency)}</p>\n        </Card>\n      </div>\n\n      {/* Status Counts */}\n      <div className=\"flex items-center gap-4 text-sm\">\n        <div className=\"flex items-center gap-1\">\n          <CheckCircle className=\"h-4 w-4 text-green-600\" />\n          <span>{summary.matchedCount} matched</span>\n        </div>\n        <div className=\"flex items-center gap-1\">\n          <XCircle className=\"h-4 w-4 text-red-600\" />\n          <span>{summary.unmatchedCount} unmatched</span>\n        </div>\n        <div className=\"flex items-center gap-1\">\n          <AlertCircle className=\"h-4 w-4 text-amber-600\" />\n          <span>{summary.partialCount} partial</span>\n        </div>\n      </div>\n    </div>\n  )\n}\n\n// ============================================================================\n// Main Component\n// ============================================================================\n\nexport function ReconciliationWidget({\n  items,\n  subledgerName = \"Subledger\",\n  glAccountName = \"General Ledger\",\n  onReconcile,\n  onDrillDown,\n  onAutoMatch,\n  onExport,\n  onRefresh,\n  currency = \"$\",\n  showSuggestions = true,\n  className,\n}: ReconciliationWidgetProps) {\n  const [selectedIds, setSelectedIds] = React.useState<Set<string>>(new Set())\n  const [isReconciling, setIsReconciling] = React.useState(false)\n  const [isAutoMatching, setIsAutoMatching] = React.useState(false)\n  const [isRefreshing, setIsRefreshing] = React.useState(false)\n\n  const summary = calculateSummary(items)\n  const unmatchedItems = items.filter((i) => i.status !== \"matched\")\n\n  const toggleSelection = (id: string) => {\n    setSelectedIds((prev) => {\n      const next = new Set(prev)\n      if (next.has(id)) {\n        next.delete(id)\n      } else {\n        next.add(id)\n      }\n      return next\n    })\n  }\n\n  const handleReconcile = async () => {\n    if (!onReconcile || selectedIds.size === 0) return\n    setIsReconciling(true)\n    try {\n      await onReconcile(Array.from(selectedIds))\n      setSelectedIds(new Set())\n    } finally {\n      setIsReconciling(false)\n    }\n  }\n\n  const handleAutoMatch = async () => {\n    if (!onAutoMatch) return\n    setIsAutoMatching(true)\n    try {\n      await onAutoMatch()\n    } finally {\n      setIsAutoMatching(false)\n    }\n  }\n\n  const handleRefresh = async () => {\n    if (!onRefresh) return\n    setIsRefreshing(true)\n    try {\n      await onRefresh()\n    } finally {\n      setIsRefreshing(false)\n    }\n  }\n\n  return (\n    <Card className={className}>\n      <CardHeader>\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <CardTitle className=\"flex items-center gap-2\">\n              <ArrowLeftRight className=\"h-5 w-5\" />\n              Reconciliation\n            </CardTitle>\n            <CardDescription>\n              {subledgerName} ↔ {glAccountName}\n            </CardDescription>\n          </div>\n          <div className=\"flex items-center gap-2\">\n            {onAutoMatch && (\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={handleAutoMatch}\n                disabled={isAutoMatching}\n              >\n                {isAutoMatching ? (\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                ) : (\n                  <Sparkles className=\"mr-2 h-4 w-4\" />\n                )}\n                Auto-Match\n              </Button>\n            )}\n            {onRefresh && (\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={handleRefresh}\n                disabled={isRefreshing}\n              >\n                <RefreshCw className={cn(\"h-4 w-4\", isRefreshing && \"animate-spin\")} />\n              </Button>\n            )}\n            {onExport && (\n              <Button variant=\"outline\" size=\"sm\" onClick={() => onExport(\"csv\")}>\n                <Download className=\"h-4 w-4\" />\n              </Button>\n            )}\n          </div>\n        </div>\n      </CardHeader>\n\n      <CardContent className=\"space-y-6\">\n        {/* Summary */}\n        <ReconciliationSummaryCard\n          summary={summary}\n          subledgerName={subledgerName}\n          glAccountName={glAccountName}\n          currency={currency}\n        />\n\n        {/* Reconciliation Table */}\n        {unmatchedItems.length > 0 && (\n          <div>\n            <div className=\"flex items-center justify-between mb-4\">\n              <h4 className=\"font-semibold\">Items Requiring Attention</h4>\n              {selectedIds.size > 0 && onReconcile && (\n                <Button\n                  size=\"sm\"\n                  onClick={handleReconcile}\n                  disabled={isReconciling}\n                >\n                  {isReconciling ? (\n                    <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                  ) : (\n                    <CheckCircle className=\"mr-2 h-4 w-4\" />\n                  )}\n                  Reconcile ({selectedIds.size})\n                </Button>\n              )}\n            </div>\n\n            <div className=\"rounded-lg border\">\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    {onReconcile && <TableHead className=\"w-10\" />}\n                    <TableHead>Reference</TableHead>\n                    <TableHead>Description</TableHead>\n                    <TableHead className=\"text-right\">{subledgerName}</TableHead>\n                    <TableHead className=\"text-right\">{glAccountName}</TableHead>\n                    <TableHead className=\"text-right\">Difference</TableHead>\n                    <TableHead className=\"w-24\">Status</TableHead>\n                    <TableHead className=\"w-20\" />\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {unmatchedItems.map((item) => (\n                    <TableRow\n                      key={item.id}\n                      className={cn(selectedIds.has(item.id) && \"bg-primary/5\")}\n                    >\n                      {onReconcile && (\n                        <TableCell>\n                          <Checkbox\n                            checked={selectedIds.has(item.id)}\n                            onCheckedChange={() => toggleSelection(item.id)}\n                          />\n                        </TableCell>\n                      )}\n                      <TableCell className=\"font-mono\">{item.reference}</TableCell>\n                      <TableCell>\n                        <div>\n                          <p>{item.description}</p>\n                          {showSuggestions && item.suggestedMatch && (\n                            <div className=\"mt-1 flex items-center gap-1 text-xs text-primary\">\n                              <Zap className=\"h-3 w-3\" />\n                              <span>\n                                Match suggested ({item.suggestedMatch.confidence}% confidence)\n                              </span>\n                            </div>\n                          )}\n                        </div>\n                      </TableCell>\n                      <TableCell className=\"text-right font-mono\">\n                        <button\n                          className=\"hover:text-primary hover:underline\"\n                          onClick={() => onDrillDown?.(item, \"subledger\")}\n                        >\n                          {formatCurrency(item.subledgerAmount, currency)}\n                        </button>\n                      </TableCell>\n                      <TableCell className=\"text-right font-mono\">\n                        <button\n                          className=\"hover:text-primary hover:underline\"\n                          onClick={() => onDrillDown?.(item, \"gl\")}\n                        >\n                          {formatCurrency(item.glAmount, currency)}\n                        </button>\n                      </TableCell>\n                      <TableCell\n                        className={cn(\n                          \"text-right font-mono font-medium\",\n                          item.difference !== 0 && \"text-red-600\"\n                        )}\n                      >\n                        {formatCurrency(item.difference, currency)}\n                      </TableCell>\n                      <TableCell>\n                        <StatusBadge status={item.status} />\n                      </TableCell>\n                      <TableCell>\n                        {onDrillDown && (\n                          <Button\n                            variant=\"ghost\"\n                            size=\"sm\"\n                            onClick={() => onDrillDown(item, \"subledger\")}\n                          >\n                            <ExternalLink className=\"h-3 w-3\" />\n                          </Button>\n                        )}\n                      </TableCell>\n                    </TableRow>\n                  ))}\n                </TableBody>\n              </Table>\n            </div>\n          </div>\n        )}\n\n        {/* All Matched Message */}\n        {unmatchedItems.length === 0 && (\n          <div className=\"flex flex-col items-center justify-center py-12 text-center\">\n            <CheckCircle className=\"h-12 w-12 text-green-500\" />\n            <h3 className=\"mt-4 font-semibold\">Fully Reconciled!</h3>\n            <p className=\"text-sm text-muted-foreground\">\n              All items are matched between {subledgerName} and {glAccountName}\n            </p>\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  )\n}\n\n// ============================================================================\n// Exports\n// ============================================================================\n\nexport type { ReconciliationStatus, ReconciliationItem, ReconciliationSummary }\n"
    }
  ]
}