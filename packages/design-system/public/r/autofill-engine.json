{
  "$schema": "https://ui.shadcn.com/schema/registry-item.json",
  "name": "autofill-engine",
  "type": "registry:block",
  "title": "Autofill Engine (Cobalt)",
  "description": "Context-aware field population with AI suggestions, confidence indicators, and one-click autofill",
  "categories": [
    "cobalt",
    "execution",
    "ai",
    "forms"
  ],
  "registryDependencies": [
    "card",
    "button",
    "input",
    "tooltip"
  ],
  "dependencies": [],
  "devDependencies": [],
  "files": [
    {
      "path": "src/blocks/cobalt/autofill-engine.tsx",
      "type": "registry:component",
      "content": "\"use client\"\n\n/**\n * Autofill Engine - Cobalt Kernel Component\n *\n * Context-aware field population with AI suggestions.\n * Implements A01-CANONICAL.md §4 — Cobalt Kernel (Smart Execution)\n *\n * Features:\n * - Context detection from related records\n * - AI-powered value suggestions\n * - Confidence indicators\n * - One-click autofill\n * - Learning from user corrections\n *\n * @example\n * ```tsx\n * import { AutofillEngine, useAutofill } from \"@workspace/design-system\"\n *\n * const { suggestions, applyAll, dismiss } = useAutofill({\n *   context: { customerId: \"123\" },\n *   fields: formFields,\n * })\n *\n * <AutofillEngine\n *   suggestions={suggestions}\n *   onApply={(fieldId) => applyField(fieldId)}\n *   onApplyAll={() => applyAll()}\n * />\n * ```\n */\n\nimport * as React from \"react\"\nimport { cn } from \"@/lib/utils\"\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/card\"\nimport { Badge } from \"@/components/badge\"\nimport { Button } from \"@/components/button\"\nimport { Progress } from \"@/components/progress\"\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/tooltip\"\nimport {\n  Sparkles,\n  Check,\n  X,\n  ChevronDown,\n  ChevronUp,\n  Zap,\n  History,\n  AlertCircle,\n  Lightbulb,\n  Loader2,\n  RefreshCw,\n} from \"lucide-react\"\n\n// ============================================================================\n// Types\n// ============================================================================\n\nexport type SuggestionSource = \"history\" | \"related\" | \"ai\" | \"default\" | \"pattern\"\n\nexport interface AutofillSuggestion {\n  fieldId: string\n  fieldLabel: string\n  suggestedValue: string | number | boolean\n  displayValue?: string\n  confidence: number // 0-100\n  source: SuggestionSource\n  reasoning?: string\n  alternatives?: {\n    value: string | number | boolean\n    displayValue?: string\n    confidence: number\n  }[]\n}\n\nexport interface AutofillEngineProps {\n  /** Field suggestions */\n  suggestions: AutofillSuggestion[]\n  /** Apply single suggestion */\n  onApply?: (fieldId: string, value: AutofillSuggestion[\"suggestedValue\"]) => void\n  /** Apply all suggestions */\n  onApplyAll?: () => void\n  /** Dismiss single suggestion */\n  onDismiss?: (fieldId: string) => void\n  /** Dismiss all */\n  onDismissAll?: () => void\n  /** Refresh suggestions */\n  onRefresh?: () => Promise<void>\n  /** Title */\n  title?: string\n  /** Compact mode */\n  compact?: boolean\n  /** Auto-collapse threshold */\n  collapseThreshold?: number\n  /** Custom className */\n  className?: string\n}\n\nexport interface UseAutofillOptions {\n  /** Context for suggestions (e.g., related record IDs) */\n  context: Record<string, unknown>\n  /** Field definitions */\n  fields: { id: string; label: string; type: string }[]\n  /** Fetch suggestions callback */\n  fetchSuggestions?: (context: Record<string, unknown>) => Promise<AutofillSuggestion[]>\n}\n\n// ============================================================================\n// Constants\n// ============================================================================\n\nconst SOURCE_CONFIG: Record<SuggestionSource, { icon: React.ElementType; label: string; color: string }> = {\n  history: { icon: History, label: \"From History\", color: \"text-blue-600\" },\n  related: { icon: Zap, label: \"Related Record\", color: \"text-purple-600\" },\n  ai: { icon: Sparkles, label: \"AI Suggested\", color: \"text-primary\" },\n  default: { icon: Lightbulb, label: \"Default Value\", color: \"text-gray-600\" },\n  pattern: { icon: Zap, label: \"Pattern Match\", color: \"text-amber-600\" },\n}\n\n// ============================================================================\n// Hook\n// ============================================================================\n\nexport function useAutofill(options: UseAutofillOptions) {\n  const [suggestions, setSuggestions] = React.useState<AutofillSuggestion[]>([])\n  const [isLoading, setIsLoading] = React.useState(false)\n  const [appliedFields, setAppliedFields] = React.useState<Set<string>>(new Set())\n\n  const refresh = React.useCallback(async () => {\n    if (!options.fetchSuggestions) return\n    setIsLoading(true)\n    try {\n      const result = await options.fetchSuggestions(options.context)\n      setSuggestions(result)\n    } finally {\n      setIsLoading(false)\n    }\n  }, [options.context, options.fetchSuggestions])\n\n  const apply = React.useCallback((fieldId: string) => {\n    setAppliedFields((prev) => new Set([...prev, fieldId]))\n  }, [])\n\n  const applyAll = React.useCallback(() => {\n    setAppliedFields(new Set(suggestions.map((s) => s.fieldId)))\n  }, [suggestions])\n\n  const dismiss = React.useCallback((fieldId: string) => {\n    setSuggestions((prev) => prev.filter((s) => s.fieldId !== fieldId))\n  }, [])\n\n  const dismissAll = React.useCallback(() => {\n    setSuggestions([])\n  }, [])\n\n  return {\n    suggestions: suggestions.filter((s) => !appliedFields.has(s.fieldId)),\n    isLoading,\n    refresh,\n    apply,\n    applyAll,\n    dismiss,\n    dismissAll,\n    appliedCount: appliedFields.size,\n  }\n}\n\n// ============================================================================\n// Confidence Badge\n// ============================================================================\n\nfunction ConfidenceBadge({ confidence }: { confidence: number }) {\n  const getColor = () => {\n    if (confidence >= 90) return \"bg-green-100 text-green-700\"\n    if (confidence >= 70) return \"bg-blue-100 text-blue-700\"\n    if (confidence >= 50) return \"bg-amber-100 text-amber-700\"\n    return \"bg-gray-100 text-gray-700\"\n  }\n\n  return (\n    <Badge className={cn(\"text-xs\", getColor())}>\n      {confidence}%\n    </Badge>\n  )\n}\n\n// ============================================================================\n// Suggestion Card\n// ============================================================================\n\nfunction SuggestionCard({\n  suggestion,\n  onApply,\n  onDismiss,\n  isApplying,\n  compact,\n}: {\n  suggestion: AutofillSuggestion\n  onApply?: () => void\n  onDismiss?: () => void\n  isApplying: boolean\n  compact: boolean\n}) {\n  const [showAlternatives, setShowAlternatives] = React.useState(false)\n  const sourceConfig = SOURCE_CONFIG[suggestion.source]\n  const SourceIcon = sourceConfig.icon\n\n  return (\n    <div\n      className={cn(\n        \"rounded-lg border p-3 transition-all hover:shadow-sm\",\n        suggestion.confidence >= 90 && \"border-green-200 bg-green-50/50 dark:bg-green-950/20\",\n        suggestion.confidence < 50 && \"border-amber-200 bg-amber-50/50 dark:bg-amber-950/20\"\n      )}\n    >\n      <div className=\"flex items-start justify-between gap-2\">\n        <div className=\"flex-1 min-w-0\">\n          <div className=\"flex items-center gap-2 flex-wrap\">\n            <span className=\"font-medium text-sm\">{suggestion.fieldLabel}</span>\n            <ConfidenceBadge confidence={suggestion.confidence} />\n            <TooltipProvider>\n              <Tooltip>\n                <TooltipTrigger>\n                  <span className={cn(\"flex items-center gap-1 text-xs\", sourceConfig.color)}>\n                    <SourceIcon className=\"h-3 w-3\" />\n                    {sourceConfig.label}\n                  </span>\n                </TooltipTrigger>\n                {suggestion.reasoning && (\n                  <TooltipContent>\n                    <p className=\"max-w-xs\">{suggestion.reasoning}</p>\n                  </TooltipContent>\n                )}\n              </Tooltip>\n            </TooltipProvider>\n          </div>\n          <div className=\"mt-1 flex items-center gap-2\">\n            <code className=\"rounded bg-muted px-2 py-0.5 text-sm font-mono\">\n              {suggestion.displayValue ?? String(suggestion.suggestedValue)}\n            </code>\n          </div>\n\n          {/* Alternatives */}\n          {!compact && suggestion.alternatives && suggestion.alternatives.length > 0 && (\n            <div className=\"mt-2\">\n              <button\n                className=\"flex items-center gap-1 text-xs text-muted-foreground hover:text-foreground\"\n                onClick={() => setShowAlternatives(!showAlternatives)}\n              >\n                {showAlternatives ? (\n                  <ChevronUp className=\"h-3 w-3\" />\n                ) : (\n                  <ChevronDown className=\"h-3 w-3\" />\n                )}\n                {suggestion.alternatives.length} alternative{suggestion.alternatives.length > 1 ? \"s\" : \"\"}\n              </button>\n              {showAlternatives && (\n                <div className=\"mt-1 space-y-1 ml-4\">\n                  {suggestion.alternatives.map((alt, index) => (\n                    <div key={index} className=\"flex items-center gap-2 text-xs\">\n                      <code className=\"rounded bg-muted/50 px-1.5 py-0.5 font-mono\">\n                        {alt.displayValue ?? String(alt.value)}\n                      </code>\n                      <span className=\"text-muted-foreground\">{alt.confidence}%</span>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </div>\n          )}\n        </div>\n\n        <div className=\"flex items-center gap-1 shrink-0\">\n          {onApply && (\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              className=\"h-8 w-8 p-0 text-green-600 hover:text-green-700 hover:bg-green-50\"\n              onClick={onApply}\n              disabled={isApplying}\n            >\n              {isApplying ? (\n                <Loader2 className=\"h-4 w-4 animate-spin\" />\n              ) : (\n                <Check className=\"h-4 w-4\" />\n              )}\n            </Button>\n          )}\n          {onDismiss && (\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              className=\"h-8 w-8 p-0 text-muted-foreground hover:text-destructive\"\n              onClick={onDismiss}\n            >\n              <X className=\"h-4 w-4\" />\n            </Button>\n          )}\n        </div>\n      </div>\n    </div>\n  )\n}\n\n// ============================================================================\n// Main Component\n// ============================================================================\n\nexport function AutofillEngine({\n  suggestions,\n  onApply,\n  onApplyAll,\n  onDismiss,\n  onDismissAll,\n  onRefresh,\n  title = \"Smart Autofill\",\n  compact = false,\n  collapseThreshold = 5,\n  className,\n}: AutofillEngineProps) {\n  const [isExpanded, setIsExpanded] = React.useState(suggestions.length <= collapseThreshold)\n  const [applyingField, setApplyingField] = React.useState<string | null>(null)\n  const [isApplyingAll, setIsApplyingAll] = React.useState(false)\n  const [isRefreshing, setIsRefreshing] = React.useState(false)\n\n  const displayedSuggestions = isExpanded ? suggestions : suggestions.slice(0, collapseThreshold)\n  const hiddenCount = suggestions.length - collapseThreshold\n\n  const handleApply = async (fieldId: string, value: AutofillSuggestion[\"suggestedValue\"]) => {\n    if (!onApply) return\n    setApplyingField(fieldId)\n    try {\n      onApply(fieldId, value)\n    } finally {\n      setApplyingField(null)\n    }\n  }\n\n  const handleApplyAll = async () => {\n    if (!onApplyAll) return\n    setIsApplyingAll(true)\n    try {\n      onApplyAll()\n    } finally {\n      setIsApplyingAll(false)\n    }\n  }\n\n  const handleRefresh = async () => {\n    if (!onRefresh) return\n    setIsRefreshing(true)\n    try {\n      await onRefresh()\n    } finally {\n      setIsRefreshing(false)\n    }\n  }\n\n  if (suggestions.length === 0) {\n    return null\n  }\n\n  // Average confidence\n  const avgConfidence =\n    suggestions.reduce((sum, s) => sum + s.confidence, 0) / suggestions.length\n\n  return (\n    <Card className={cn(\"border-primary/30 bg-primary/5\", className)}>\n      <CardHeader className={cn(compact && \"pb-2\")}>\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <CardTitle className=\"flex items-center gap-2 text-base\">\n              <Sparkles className=\"h-4 w-4 text-primary\" />\n              {title}\n            </CardTitle>\n            {!compact && (\n              <CardDescription>\n                {suggestions.length} suggestion{suggestions.length > 1 ? \"s\" : \"\"} •{\" \"}\n                {avgConfidence.toFixed(0)}% avg confidence\n              </CardDescription>\n            )}\n          </div>\n          <div className=\"flex items-center gap-2\">\n            {onRefresh && (\n              <Button\n                variant=\"ghost\"\n                size=\"sm\"\n                onClick={handleRefresh}\n                disabled={isRefreshing}\n              >\n                <RefreshCw className={cn(\"h-4 w-4\", isRefreshing && \"animate-spin\")} />\n              </Button>\n            )}\n            {onApplyAll && (\n              <Button\n                variant=\"default\"\n                size=\"sm\"\n                onClick={handleApplyAll}\n                disabled={isApplyingAll}\n              >\n                {isApplyingAll ? (\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                ) : (\n                  <Zap className=\"mr-2 h-4 w-4\" />\n                )}\n                Apply All\n              </Button>\n            )}\n            {onDismissAll && (\n              <Button variant=\"ghost\" size=\"sm\" onClick={onDismissAll}>\n                Dismiss\n              </Button>\n            )}\n          </div>\n        </div>\n      </CardHeader>\n\n      <CardContent className={cn(\"space-y-2\", compact && \"pt-0\")}>\n        {displayedSuggestions.map((suggestion) => (\n          <SuggestionCard\n            key={suggestion.fieldId}\n            suggestion={suggestion}\n            onApply={\n              onApply\n                ? () => handleApply(suggestion.fieldId, suggestion.suggestedValue)\n                : undefined\n            }\n            onDismiss={onDismiss ? () => onDismiss(suggestion.fieldId) : undefined}\n            isApplying={applyingField === suggestion.fieldId}\n            compact={compact}\n          />\n        ))}\n\n        {/* Expand/Collapse */}\n        {suggestions.length > collapseThreshold && (\n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            className=\"w-full\"\n            onClick={() => setIsExpanded(!isExpanded)}\n          >\n            {isExpanded ? (\n              <>\n                <ChevronUp className=\"mr-2 h-4 w-4\" />\n                Show Less\n              </>\n            ) : (\n              <>\n                <ChevronDown className=\"mr-2 h-4 w-4\" />\n                Show {hiddenCount} More\n              </>\n            )}\n          </Button>\n        )}\n\n        {/* Low confidence warning */}\n        {avgConfidence < 50 && (\n          <div className=\"flex items-start gap-2 rounded-lg border border-amber-200 bg-amber-50 dark:bg-amber-950 p-2 text-xs\">\n            <AlertCircle className=\"h-4 w-4 text-amber-600 shrink-0\" />\n            <span className=\"text-amber-700 dark:text-amber-300\">\n              Suggestions have low confidence. Review carefully before applying.\n            </span>\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  )\n}\n\n// ============================================================================\n// Exports\n// ============================================================================\n\nexport type { SuggestionSource, AutofillSuggestion, UseAutofillOptions }\n"
    }
  ]
}