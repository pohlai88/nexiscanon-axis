{
  "$schema": "https://ui.shadcn.com/schema/registry-item.json",
  "name": "consultation-thread",
  "type": "registry:block",
  "title": "Consultation Thread (AFANDA)",
  "description": "Structured discussion threads with voting, mentions, canonical outcome recording, and expert tagging",
  "categories": [
    "afanda",
    "collaboration",
    "discussion"
  ],
  "registryDependencies": [
    "card",
    "button",
    "avatar",
    "textarea"
  ],
  "dependencies": [],
  "devDependencies": [],
  "files": [
    {
      "path": "src/blocks/afanda/consultation-thread.tsx",
      "type": "registry:component",
      "content": "\"use client\"\n\n/**\n * Consultation Thread - AFANDA Platform Component\n *\n * Structured discussion with canonical outcomes.\n * Implements A01-CANONICAL.md §8 — AFANDA (Collaborative Decision Making)\n *\n * Features:\n * - Threaded discussion\n * - Tag participants\n * - Voting/polling\n * - Resolution tracking\n * - Canonical outcome recording\n *\n * @example\n * ```tsx\n * import { ConsultationThread } from \"@workspace/design-system\"\n *\n * <ConsultationThread\n *   thread={consultationData}\n *   onAddMessage={(msg) => postMessage(msg)}\n *   onResolve={(resolution) => closeThread(resolution)}\n * />\n * ```\n */\n\nimport * as React from \"react\"\nimport { cn } from \"@/lib/utils\"\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription, CardFooter } from \"@/components/card\"\nimport { Badge } from \"@/components/badge\"\nimport { Button } from \"@/components/button\"\nimport { Input } from \"@/components/input\"\nimport { Textarea } from \"@/components/textarea\"\nimport { Avatar } from \"@/components/avatar\"\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/select\"\nimport {\n  MessageSquare,\n  Users,\n  CheckCircle,\n  Clock,\n  ThumbsUp,\n  ThumbsDown,\n  AtSign,\n  Send,\n  Lock,\n  AlertCircle,\n  ChevronDown,\n  ChevronUp,\n  FileText,\n  Loader2,\n} from \"lucide-react\"\n\n// ============================================================================\n// Types\n// ============================================================================\n\nexport type ThreadStatus = \"open\" | \"pending_resolution\" | \"resolved\" | \"closed\"\n\nexport interface ThreadParticipant {\n  id: string\n  name: string\n  role: string\n  avatarUrl?: string\n}\n\nexport interface ThreadMessage {\n  id: string\n  author: ThreadParticipant\n  content: string\n  createdAt: string | Date\n  mentions?: string[] // participant IDs\n  attachments?: { id: string; name: string; url?: string }[]\n  votes?: {\n    up: string[] // participant IDs\n    down: string[]\n  }\n  isResolution?: boolean\n}\n\nexport interface ThreadResolution {\n  summary: string\n  decision: string\n  approvedBy: ThreadParticipant[]\n  timestamp: string | Date\n}\n\nexport interface ConsultationThreadData {\n  id: string\n  title: string\n  description?: string\n  status: ThreadStatus\n  priority: \"low\" | \"normal\" | \"high\" | \"urgent\"\n  initiatedBy: ThreadParticipant\n  createdAt: string | Date\n  dueDate?: string | Date\n  participants: ThreadParticipant[]\n  messages: ThreadMessage[]\n  resolution?: ThreadResolution\n  tags?: string[]\n  relatedDocumentRef?: string\n}\n\nexport interface ConsultationThreadProps {\n  /** Thread data */\n  thread: ConsultationThreadData\n  /** Current user */\n  currentUser: ThreadParticipant\n  /** Add message callback */\n  onAddMessage?: (content: string, mentions?: string[]) => Promise<void>\n  /** Vote callback */\n  onVote?: (messageId: string, vote: \"up\" | \"down\") => void\n  /** Resolve callback */\n  onResolve?: (resolution: Omit<ThreadResolution, \"timestamp\">) => Promise<void>\n  /** Close callback */\n  onClose?: () => void\n  /** Custom className */\n  className?: string\n}\n\n// ============================================================================\n// Constants\n// ============================================================================\n\nconst STATUS_CONFIG = {\n  open: { icon: MessageSquare, color: \"bg-blue-100 text-blue-700\", label: \"Open\" },\n  pending_resolution: { icon: Clock, color: \"bg-amber-100 text-amber-700\", label: \"Pending Resolution\" },\n  resolved: { icon: CheckCircle, color: \"bg-green-100 text-green-700\", label: \"Resolved\" },\n  closed: { icon: Lock, color: \"bg-gray-100 text-gray-700\", label: \"Closed\" },\n}\n\nconst PRIORITY_CONFIG = {\n  low: { color: \"bg-gray-100 text-gray-700\" },\n  normal: { color: \"bg-blue-100 text-blue-700\" },\n  high: { color: \"bg-amber-100 text-amber-700\" },\n  urgent: { color: \"bg-red-100 text-red-700\" },\n}\n\n// ============================================================================\n// Message Component\n// ============================================================================\n\nfunction MessageCard({\n  message,\n  participants,\n  currentUserId,\n  onVote,\n}: {\n  message: ThreadMessage\n  participants: ThreadParticipant[]\n  currentUserId: string\n  onVote?: (messageId: string, vote: \"up\" | \"down\") => void\n}) {\n  const upVotes = message.votes?.up?.length ?? 0\n  const downVotes = message.votes?.down?.length ?? 0\n  const hasVotedUp = message.votes?.up?.includes(currentUserId)\n  const hasVotedDown = message.votes?.down?.includes(currentUserId)\n\n  return (\n    <div\n      className={cn(\n        \"rounded-lg border p-4\",\n        message.isResolution && \"border-green-300 bg-green-50 dark:bg-green-950\"\n      )}\n    >\n      <div className=\"flex items-start gap-3\">\n        <Avatar className=\"h-8 w-8 shrink-0\">\n          {message.author.avatarUrl ? (\n            <img src={message.author.avatarUrl} alt={message.author.name} />\n          ) : (\n            <div className=\"flex h-full w-full items-center justify-center bg-primary text-primary-foreground text-sm font-medium\">\n              {message.author.name.charAt(0).toUpperCase()}\n            </div>\n          )}\n        </Avatar>\n        <div className=\"flex-1 min-w-0\">\n          <div className=\"flex items-center gap-2 flex-wrap\">\n            <span className=\"font-medium\">{message.author.name}</span>\n            <span className=\"text-xs text-muted-foreground\">({message.author.role})</span>\n            <span className=\"text-xs text-muted-foreground\">\n              {new Date(message.createdAt).toLocaleString()}\n            </span>\n            {message.isResolution && (\n              <Badge className=\"bg-green-100 text-green-700 gap-1\">\n                <CheckCircle className=\"h-3 w-3\" />\n                Resolution\n              </Badge>\n            )}\n          </div>\n\n          <div className=\"mt-2 text-sm whitespace-pre-wrap\">{message.content}</div>\n\n          {/* Mentions */}\n          {message.mentions && message.mentions.length > 0 && (\n            <div className=\"mt-2 flex items-center gap-1 flex-wrap\">\n              <AtSign className=\"h-3 w-3 text-muted-foreground\" />\n              {message.mentions.map((id) => {\n                const p = participants.find((p) => p.id === id)\n                return p ? (\n                  <Badge key={id} variant=\"secondary\" className=\"text-xs\">\n                    {p.name}\n                  </Badge>\n                ) : null\n              })}\n            </div>\n          )}\n\n          {/* Attachments */}\n          {message.attachments && message.attachments.length > 0 && (\n            <div className=\"mt-2 flex items-center gap-2 flex-wrap\">\n              {message.attachments.map((att) => (\n                <Button key={att.id} variant=\"outline\" size=\"sm\" className=\"h-7 text-xs\">\n                  <FileText className=\"mr-1 h-3 w-3\" />\n                  {att.name}\n                </Button>\n              ))}\n            </div>\n          )}\n\n          {/* Votes */}\n          {onVote && (\n            <div className=\"mt-3 flex items-center gap-2\">\n              <Button\n                variant={hasVotedUp ? \"default\" : \"outline\"}\n                size=\"sm\"\n                className=\"h-7\"\n                onClick={() => onVote(message.id, \"up\")}\n              >\n                <ThumbsUp className=\"mr-1 h-3 w-3\" />\n                {upVotes}\n              </Button>\n              <Button\n                variant={hasVotedDown ? \"destructive\" : \"outline\"}\n                size=\"sm\"\n                className=\"h-7\"\n                onClick={() => onVote(message.id, \"down\")}\n              >\n                <ThumbsDown className=\"mr-1 h-3 w-3\" />\n                {downVotes}\n              </Button>\n            </div>\n          )}\n        </div>\n      </div>\n    </div>\n  )\n}\n\n// ============================================================================\n// Resolution Card\n// ============================================================================\n\nfunction ResolutionCard({ resolution }: { resolution: ThreadResolution }) {\n  return (\n    <div className=\"rounded-lg border-2 border-green-500 bg-green-50 dark:bg-green-950 p-4\">\n      <div className=\"flex items-center gap-2 mb-3\">\n        <CheckCircle className=\"h-5 w-5 text-green-600\" />\n        <h4 className=\"font-semibold text-green-800 dark:text-green-200\">Canonical Resolution</h4>\n      </div>\n      <div className=\"space-y-3\">\n        <div>\n          <p className=\"text-xs text-green-700 dark:text-green-300 mb-1\">Summary</p>\n          <p className=\"text-sm font-medium text-green-800 dark:text-green-200\">{resolution.summary}</p>\n        </div>\n        <div>\n          <p className=\"text-xs text-green-700 dark:text-green-300 mb-1\">Decision</p>\n          <p className=\"text-sm text-green-800 dark:text-green-200\">{resolution.decision}</p>\n        </div>\n        <div className=\"flex items-center gap-2 pt-2 border-t border-green-200\">\n          <p className=\"text-xs text-green-600\">Approved by:</p>\n          <div className=\"flex -space-x-2\">\n            {resolution.approvedBy.map((p) => (\n              <Avatar key={p.id} className=\"h-6 w-6 border-2 border-background\">\n                <div className=\"flex h-full w-full items-center justify-center bg-green-600 text-white text-xs\">\n                  {p.name.charAt(0)}\n                </div>\n              </Avatar>\n            ))}\n          </div>\n          <span className=\"text-xs text-green-600 ml-auto\">\n            {new Date(resolution.timestamp).toLocaleString()}\n          </span>\n        </div>\n      </div>\n      <div className=\"mt-3 flex items-center gap-1 text-xs text-green-600\">\n        <Lock className=\"h-3 w-3\" />\n        <span>This resolution is immutable and recorded in the audit trail.</span>\n      </div>\n    </div>\n  )\n}\n\n// ============================================================================\n// Main Component\n// ============================================================================\n\nexport function ConsultationThread({\n  thread,\n  currentUser,\n  onAddMessage,\n  onVote,\n  onResolve,\n  onClose,\n  className,\n}: ConsultationThreadProps) {\n  const [newMessage, setNewMessage] = React.useState(\"\")\n  const [isSending, setIsSending] = React.useState(false)\n  const [showResolveForm, setShowResolveForm] = React.useState(false)\n  const [resolutionSummary, setResolutionSummary] = React.useState(\"\")\n  const [resolutionDecision, setResolutionDecision] = React.useState(\"\")\n  const [isResolving, setIsResolving] = React.useState(false)\n\n  const statusConfig = STATUS_CONFIG[thread.status]\n  const StatusIcon = statusConfig.icon\n  const priorityConfig = PRIORITY_CONFIG[thread.priority]\n\n  const isOpen = thread.status === \"open\" || thread.status === \"pending_resolution\"\n\n  const handleSend = async () => {\n    if (!onAddMessage || !newMessage.trim()) return\n    setIsSending(true)\n    try {\n      await onAddMessage(newMessage)\n      setNewMessage(\"\")\n    } finally {\n      setIsSending(false)\n    }\n  }\n\n  const handleResolve = async () => {\n    if (!onResolve || !resolutionSummary || !resolutionDecision) return\n    setIsResolving(true)\n    try {\n      await onResolve({\n        summary: resolutionSummary,\n        decision: resolutionDecision,\n        approvedBy: [currentUser],\n      })\n      setShowResolveForm(false)\n    } finally {\n      setIsResolving(false)\n    }\n  }\n\n  return (\n    <Card className={className}>\n      <CardHeader>\n        <div className=\"flex items-start justify-between\">\n          <div className=\"flex-1\">\n            <CardTitle className=\"flex items-center gap-2\">\n              <MessageSquare className=\"h-5 w-5\" />\n              {thread.title}\n            </CardTitle>\n            <CardDescription className=\"mt-1\">\n              {thread.description}\n            </CardDescription>\n            <div className=\"flex items-center gap-2 mt-2 flex-wrap\">\n              <Badge className={cn(\"gap-1\", statusConfig.color)}>\n                <StatusIcon className=\"h-3 w-3\" />\n                {statusConfig.label}\n              </Badge>\n              <Badge className={priorityConfig.color} variant=\"outline\">\n                {thread.priority.charAt(0).toUpperCase() + thread.priority.slice(1)}\n              </Badge>\n              {thread.dueDate && (\n                <Badge variant=\"outline\" className=\"gap-1\">\n                  <Clock className=\"h-3 w-3\" />\n                  Due: {new Date(thread.dueDate).toLocaleDateString()}\n                </Badge>\n              )}\n              {thread.tags?.map((tag) => (\n                <Badge key={tag} variant=\"secondary\">\n                  {tag}\n                </Badge>\n              ))}\n            </div>\n          </div>\n          <div className=\"flex items-center gap-2\">\n            <Badge variant=\"outline\" className=\"gap-1\">\n              <Users className=\"h-3 w-3\" />\n              {thread.participants.length}\n            </Badge>\n          </div>\n        </div>\n      </CardHeader>\n\n      <CardContent className=\"space-y-4\">\n        {/* Participants */}\n        <div className=\"flex items-center gap-2\">\n          <span className=\"text-xs text-muted-foreground\">Participants:</span>\n          <div className=\"flex -space-x-2\">\n            {thread.participants.slice(0, 5).map((p) => (\n              <Avatar key={p.id} className=\"h-6 w-6 border-2 border-background\">\n                {p.avatarUrl ? (\n                  <img src={p.avatarUrl} alt={p.name} />\n                ) : (\n                  <div className=\"flex h-full w-full items-center justify-center bg-muted text-xs font-medium\">\n                    {p.name.charAt(0)}\n                  </div>\n                )}\n              </Avatar>\n            ))}\n            {thread.participants.length > 5 && (\n              <span className=\"ml-2 text-xs text-muted-foreground\">\n                +{thread.participants.length - 5} more\n              </span>\n            )}\n          </div>\n        </div>\n\n        {/* Resolution (if resolved) */}\n        {thread.resolution && <ResolutionCard resolution={thread.resolution} />}\n\n        {/* Messages */}\n        <div className=\"space-y-3 max-h-[400px] overflow-y-auto\">\n          {thread.messages.map((message) => (\n            <MessageCard\n              key={message.id}\n              message={message}\n              participants={thread.participants}\n              currentUserId={currentUser.id}\n              onVote={isOpen ? onVote : undefined}\n            />\n          ))}\n        </div>\n\n        {/* Resolve Form */}\n        {showResolveForm && (\n          <div className=\"space-y-3 rounded-lg border p-4 bg-muted/50\">\n            <h4 className=\"font-medium\">Propose Resolution</h4>\n            <div className=\"space-y-2\">\n              <Input\n                placeholder=\"Resolution summary...\"\n                value={resolutionSummary}\n                onChange={(e) => setResolutionSummary(e.target.value)}\n              />\n              <Textarea\n                placeholder=\"Decision details...\"\n                value={resolutionDecision}\n                onChange={(e) => setResolutionDecision(e.target.value)}\n                rows={3}\n              />\n            </div>\n            <div className=\"flex gap-2 justify-end\">\n              <Button variant=\"outline\" onClick={() => setShowResolveForm(false)}>\n                Cancel\n              </Button>\n              <Button\n                onClick={handleResolve}\n                disabled={!resolutionSummary || !resolutionDecision || isResolving}\n              >\n                {isResolving ? (\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                ) : (\n                  <CheckCircle className=\"mr-2 h-4 w-4\" />\n                )}\n                Submit Resolution\n              </Button>\n            </div>\n          </div>\n        )}\n\n        {/* New Message Input */}\n        {isOpen && onAddMessage && (\n          <div className=\"flex gap-2\">\n            <Textarea\n              placeholder=\"Add a message...\"\n              value={newMessage}\n              onChange={(e) => setNewMessage(e.target.value)}\n              rows={2}\n              className=\"flex-1\"\n            />\n            <div className=\"flex flex-col gap-2\">\n              <Button onClick={handleSend} disabled={!newMessage.trim() || isSending}>\n                {isSending ? (\n                  <Loader2 className=\"h-4 w-4 animate-spin\" />\n                ) : (\n                  <Send className=\"h-4 w-4\" />\n                )}\n              </Button>\n            </div>\n          </div>\n        )}\n      </CardContent>\n\n      {/* Actions */}\n      {isOpen && (onResolve || onClose) && (\n        <CardFooter className=\"gap-2 justify-end border-t pt-4\">\n          {onResolve && !showResolveForm && (\n            <Button variant=\"outline\" onClick={() => setShowResolveForm(true)}>\n              <CheckCircle className=\"mr-2 h-4 w-4\" />\n              Propose Resolution\n            </Button>\n          )}\n          {onClose && (\n            <Button variant=\"outline\" onClick={onClose}>\n              Close Thread\n            </Button>\n          )}\n        </CardFooter>\n      )}\n    </Card>\n  )\n}\n\n// ============================================================================\n// Exports\n// ============================================================================\n\nexport type { ThreadStatus, ThreadParticipant, ThreadMessage, ThreadResolution, ConsultationThreadData }\n"
    }
  ]
}