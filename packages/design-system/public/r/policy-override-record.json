{
  "$schema": "https://ui.shadcn.com/schema/registry-item.json",
  "name": "policy-override-record",
  "type": "registry:block",
  "title": "Policy Override Record (Audit)",
  "description": "Documents policy overrides with justification, evidence attachment, approvals, and immutable record creation",
  "categories": [
    "audit",
    "compliance",
    "documentation"
  ],
  "registryDependencies": [
    "card",
    "textarea",
    "button",
    "dialog"
  ],
  "dependencies": [],
  "devDependencies": [],
  "files": [
    {
      "path": "src/blocks/audit/policy-override-record.tsx",
      "type": "registry:component",
      "content": "\"use client\"\n\n/**\n * Policy Override Record - Audit Component\n *\n * Document why policies were overridden with immutable records.\n * Implements A01-CANONICAL.md §5 — Nexus Doctrine (6W1H)\n *\n * Features:\n * - Override reason dropdown\n * - Free-text justification\n * - Evidence attachment\n * - Approver signature\n * - Immutable record display\n *\n * @example\n * ```tsx\n * import { PolicyOverrideRecord, PolicyOverrideForm } from \"@workspace/design-system\"\n *\n * // Display existing record\n * <PolicyOverrideRecord record={overrideRecord} />\n *\n * // Create new override\n * <PolicyOverrideForm\n *   policy={violatedPolicy}\n *   onSubmit={(data) => saveOverride(data)}\n * />\n * ```\n */\n\nimport * as React from \"react\"\nimport { cn } from \"@/lib/utils\"\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription, CardFooter } from \"@/components/card\"\nimport { Badge } from \"@/components/badge\"\nimport { Button } from \"@/components/button\"\nimport { Input } from \"@/components/input\"\nimport { Label } from \"@/components/label\"\nimport { Textarea } from \"@/components/textarea\"\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/select\"\nimport {\n  AlertTriangle,\n  FileText,\n  Shield,\n  User,\n  Calendar,\n  Lock,\n  Paperclip,\n  CheckCircle,\n  XCircle,\n  Upload,\n  Loader2,\n  Clock,\n} from \"lucide-react\"\n\n// ============================================================================\n// Types (OverrideReason imported from shared types to avoid conflicts)\n// ============================================================================\n\nimport type { OverrideReason } from \"../types\"\n\nexport type OverrideStatus = \"pending\" | \"approved\" | \"rejected\" | \"expired\"\n\nexport interface PolicyOverrideData {\n  id: string\n  policy: {\n    id: string\n    name: string\n    description?: string\n    severity: \"low\" | \"medium\" | \"high\" | \"critical\"\n  }\n  reason: OverrideReason\n  justification: string\n  evidence?: {\n    id: string\n    name: string\n    type: string\n    url?: string\n  }[]\n  requestedBy: {\n    id: string\n    name: string\n    role: string\n  }\n  requestedAt: string | Date\n  approvedBy?: {\n    id: string\n    name: string\n    role: string\n  }\n  approvedAt?: string | Date\n  status: OverrideStatus\n  expiresAt?: string | Date\n  transactionRef?: string\n  // 6W1H Context\n  sixW1H?: {\n    who: string\n    what: string\n    when: string\n    where: string\n    why: string\n    which: string\n    how: string\n  }\n}\n\nexport interface PolicyOverrideRecordProps {\n  /** Override record data */\n  record: PolicyOverrideData\n  /** Show full 6W1H context */\n  showContext?: boolean\n  /** View evidence callback */\n  onViewEvidence?: (evidence: PolicyOverrideData[\"evidence\"]) => void\n  /** Custom className */\n  className?: string\n}\n\nexport interface PolicyOverrideFormProps {\n  /** Policy being overridden */\n  policy: PolicyOverrideData[\"policy\"]\n  /** Available override reasons */\n  reasons?: OverrideReason[]\n  /** Submit callback */\n  onSubmit?: (data: Omit<PolicyOverrideData, \"id\" | \"status\" | \"requestedAt\">) => Promise<void>\n  /** Cancel callback */\n  onCancel?: () => void\n  /** Current user */\n  currentUser: PolicyOverrideData[\"requestedBy\"]\n  /** Custom className */\n  className?: string\n}\n\n// ============================================================================\n// Constants\n// ============================================================================\n\nconst DEFAULT_REASONS: OverrideReason[] = [\n  {\n    id: \"business-critical\",\n    label: \"Business Critical\",\n    description: \"Override required to complete time-sensitive business operation\",\n    requiresEvidence: true,\n  },\n  {\n    id: \"customer-exception\",\n    label: \"Customer Exception\",\n    description: \"Pre-approved exception for specific customer\",\n    requiresEvidence: true,\n  },\n  {\n    id: \"one-time\",\n    label: \"One-Time Exception\",\n    description: \"Single occurrence that won't repeat\",\n    requiresEvidence: false,\n  },\n  {\n    id: \"policy-update\",\n    label: \"Policy Being Updated\",\n    description: \"Policy is outdated and pending revision\",\n    requiresEvidence: true,\n  },\n  {\n    id: \"executive-approval\",\n    label: \"Executive Approval\",\n    description: \"Approved by authorized executive\",\n    requiresEvidence: true,\n  },\n  {\n    id: \"other\",\n    label: \"Other\",\n    description: \"Other reason - must provide detailed justification\",\n    requiresEvidence: true,\n  },\n]\n\nconst SEVERITY_CONFIG = {\n  low: { color: \"bg-blue-100 text-blue-700\", label: \"Low\" },\n  medium: { color: \"bg-amber-100 text-amber-700\", label: \"Medium\" },\n  high: { color: \"bg-orange-100 text-orange-700\", label: \"High\" },\n  critical: { color: \"bg-red-100 text-red-700\", label: \"Critical\" },\n}\n\nconst STATUS_CONFIG = {\n  pending: { icon: Clock, color: \"bg-amber-100 text-amber-700\", label: \"Pending Approval\" },\n  approved: { icon: CheckCircle, color: \"bg-green-100 text-green-700\", label: \"Approved\" },\n  rejected: { icon: XCircle, color: \"bg-red-100 text-red-700\", label: \"Rejected\" },\n  expired: { icon: Clock, color: \"bg-gray-100 text-gray-700\", label: \"Expired\" },\n}\n\n// ============================================================================\n// Record Display Component\n// ============================================================================\n\nexport function PolicyOverrideRecord({\n  record,\n  showContext = false,\n  onViewEvidence,\n  className,\n}: PolicyOverrideRecordProps) {\n  const severityConfig = SEVERITY_CONFIG[record.policy.severity]\n  const statusConfig = STATUS_CONFIG[record.status]\n  const StatusIcon = statusConfig.icon\n\n  return (\n    <Card className={cn(\"border-l-4\", record.status === \"approved\" ? \"border-l-green-500\" : record.status === \"rejected\" ? \"border-l-red-500\" : \"border-l-amber-500\", className)}>\n      <CardHeader>\n        <div className=\"flex items-start justify-between\">\n          <div>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Lock className=\"h-5 w-5\" />\n              Policy Override Record\n            </CardTitle>\n            <CardDescription className=\"flex items-center gap-2 mt-1\">\n              <Badge variant=\"outline\">{record.id}</Badge>\n              {record.transactionRef && (\n                <span className=\"text-xs\">Ref: {record.transactionRef}</span>\n              )}\n            </CardDescription>\n          </div>\n          <Badge className={cn(\"gap-1\", statusConfig.color)}>\n            <StatusIcon className=\"h-3 w-3\" />\n            {statusConfig.label}\n          </Badge>\n        </div>\n      </CardHeader>\n\n      <CardContent className=\"space-y-4\">\n        {/* Policy Info */}\n        <div className=\"rounded-lg border p-3\">\n          <div className=\"flex items-center justify-between mb-2\">\n            <h4 className=\"font-medium flex items-center gap-2\">\n              <Shield className=\"h-4 w-4\" />\n              {record.policy.name}\n            </h4>\n            <Badge className={severityConfig.color}>\n              {severityConfig.label} Severity\n            </Badge>\n          </div>\n          {record.policy.description && (\n            <p className=\"text-sm text-muted-foreground\">{record.policy.description}</p>\n          )}\n        </div>\n\n        {/* Override Details */}\n        <div className=\"grid gap-4 md:grid-cols-2\">\n          <div>\n            <p className=\"text-xs text-muted-foreground mb-1\">Override Reason</p>\n            <p className=\"font-medium\">{record.reason.label}</p>\n            {record.reason.description && (\n              <p className=\"text-xs text-muted-foreground\">{record.reason.description}</p>\n            )}\n          </div>\n          <div>\n            <p className=\"text-xs text-muted-foreground mb-1\">Requested By</p>\n            <div className=\"flex items-center gap-2\">\n              <User className=\"h-4 w-4 text-muted-foreground\" />\n              <span className=\"font-medium\">{record.requestedBy.name}</span>\n              <span className=\"text-xs text-muted-foreground\">({record.requestedBy.role})</span>\n            </div>\n            <p className=\"text-xs text-muted-foreground flex items-center gap-1 mt-1\">\n              <Calendar className=\"h-3 w-3\" />\n              {new Date(record.requestedAt).toLocaleString()}\n            </p>\n          </div>\n        </div>\n\n        {/* Justification */}\n        <div>\n          <p className=\"text-xs text-muted-foreground mb-1\">Justification</p>\n          <div className=\"rounded-lg bg-muted p-3 text-sm\">\n            {record.justification}\n          </div>\n        </div>\n\n        {/* Evidence */}\n        {record.evidence && record.evidence.length > 0 && (\n          <div>\n            <p className=\"text-xs text-muted-foreground mb-2\">Evidence Attached</p>\n            <div className=\"flex flex-wrap gap-2\">\n              {record.evidence.map((ev) => (\n                <Button\n                  key={ev.id}\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={() => onViewEvidence?.(record.evidence)}\n                  className=\"h-8\"\n                >\n                  <Paperclip className=\"mr-1 h-3 w-3\" />\n                  {ev.name}\n                </Button>\n              ))}\n            </div>\n          </div>\n        )}\n\n        {/* Approval Info */}\n        {record.approvedBy && (\n          <div className=\"rounded-lg border border-green-200 bg-green-50 dark:bg-green-950 p-3\">\n            <p className=\"text-xs text-green-700 dark:text-green-300 mb-1\">Approved By</p>\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center gap-2\">\n                <CheckCircle className=\"h-4 w-4 text-green-600\" />\n                <span className=\"font-medium text-green-700 dark:text-green-300\">{record.approvedBy.name}</span>\n                <span className=\"text-xs text-green-600\">({record.approvedBy.role})</span>\n              </div>\n              {record.approvedAt && (\n                <span className=\"text-xs text-green-600\">\n                  {new Date(record.approvedAt).toLocaleString()}\n                </span>\n              )}\n            </div>\n          </div>\n        )}\n\n        {/* Expiration */}\n        {record.expiresAt && (\n          <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n            <Clock className=\"h-4 w-4\" />\n            <span>Override expires: {new Date(record.expiresAt).toLocaleString()}</span>\n          </div>\n        )}\n\n        {/* 6W1H Context */}\n        {showContext && record.sixW1H && (\n          <div className=\"rounded-lg border p-3 space-y-2\">\n            <h4 className=\"font-medium text-sm\">6W1H Context (Immutable)</h4>\n            <div className=\"grid gap-2 text-sm\">\n              {Object.entries(record.sixW1H).map(([key, value]) => (\n                <div key={key} className=\"flex\">\n                  <span className=\"font-medium w-16 capitalize\">{key}:</span>\n                  <span className=\"text-muted-foreground\">{value}</span>\n                </div>\n              ))}\n            </div>\n          </div>\n        )}\n\n        {/* Immutability Notice */}\n        <div className=\"flex items-center gap-2 text-xs text-muted-foreground border-t pt-3\">\n          <Lock className=\"h-3 w-3\" />\n          <span>This record is immutable and cannot be modified after creation.</span>\n        </div>\n      </CardContent>\n    </Card>\n  )\n}\n\n// ============================================================================\n// Form Component\n// ============================================================================\n\nexport function PolicyOverrideForm({\n  policy,\n  reasons = DEFAULT_REASONS,\n  onSubmit,\n  onCancel,\n  currentUser,\n  className,\n}: PolicyOverrideFormProps) {\n  const [selectedReason, setSelectedReason] = React.useState<string>(\"\")\n  const [justification, setJustification] = React.useState(\"\")\n  const [files, setFiles] = React.useState<File[]>([])\n  const [isSubmitting, setIsSubmitting] = React.useState(false)\n  const fileInputRef = React.useRef<HTMLInputElement>(null)\n\n  const selectedReasonData = reasons.find((r) => r.id === selectedReason)\n  const requiresEvidence = selectedReasonData?.requiresEvidence ?? false\n  const isValid = selectedReason && justification.length >= 20 && (!requiresEvidence || files.length > 0)\n\n  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    if (e.target.files) {\n      setFiles((prev) => [...prev, ...Array.from(e.target.files!)])\n    }\n  }\n\n  const removeFile = (index: number) => {\n    setFiles((prev) => prev.filter((_, i) => i !== index))\n  }\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault()\n    if (!onSubmit || !isValid) return\n\n    setIsSubmitting(true)\n    try {\n      await onSubmit({\n        policy,\n        reason: selectedReasonData!,\n        justification,\n        evidence: files.map((f, i) => ({\n          id: `ev-${i}`,\n          name: f.name,\n          type: f.type,\n        })),\n        requestedBy: currentUser,\n      })\n    } finally {\n      setIsSubmitting(false)\n    }\n  }\n\n  const severityConfig = SEVERITY_CONFIG[policy.severity]\n\n  return (\n    <Card className={cn(\"border-l-4 border-l-amber-500\", className)}>\n      <CardHeader>\n        <CardTitle className=\"flex items-center gap-2\">\n          <AlertTriangle className=\"h-5 w-5 text-amber-600\" />\n          Request Policy Override\n        </CardTitle>\n        <CardDescription>\n          Document your justification for overriding this policy. This record is immutable.\n        </CardDescription>\n      </CardHeader>\n\n      <form onSubmit={handleSubmit}>\n        <CardContent className=\"space-y-4\">\n          {/* Policy Info */}\n          <div className=\"rounded-lg border border-amber-200 bg-amber-50 dark:bg-amber-950 p-3\">\n            <div className=\"flex items-center justify-between mb-1\">\n              <h4 className=\"font-medium flex items-center gap-2 text-amber-800 dark:text-amber-200\">\n                <Shield className=\"h-4 w-4\" />\n                {policy.name}\n              </h4>\n              <Badge className={severityConfig.color}>\n                {severityConfig.label} Severity\n              </Badge>\n            </div>\n            {policy.description && (\n              <p className=\"text-sm text-amber-700 dark:text-amber-300\">{policy.description}</p>\n            )}\n          </div>\n\n          {/* Override Reason */}\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"reason\">Override Reason *</Label>\n            <Select value={selectedReason} onValueChange={(v) => v && setSelectedReason(v)}>\n              <SelectTrigger id=\"reason\">\n                <SelectValue placeholder=\"Select a reason\" />\n              </SelectTrigger>\n              <SelectContent>\n                {reasons.map((reason) => (\n                  <SelectItem key={reason.id} value={reason.id}>\n                    <div>\n                      <span>{reason.label}</span>\n                      {reason.requiresEvidence && (\n                        <span className=\"text-xs text-muted-foreground ml-2\">(evidence required)</span>\n                      )}\n                    </div>\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n            {selectedReasonData?.description && (\n              <p className=\"text-xs text-muted-foreground\">{selectedReasonData.description}</p>\n            )}\n          </div>\n\n          {/* Justification */}\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"justification\">Justification * (min 20 characters)</Label>\n            <Textarea\n              id=\"justification\"\n              value={justification}\n              onChange={(e) => setJustification(e.target.value)}\n              placeholder=\"Provide a detailed justification for this override...\"\n              rows={4}\n            />\n            <p className=\"text-xs text-muted-foreground text-right\">\n              {justification.length}/20 minimum\n            </p>\n          </div>\n\n          {/* Evidence Upload */}\n          <div className=\"space-y-2\">\n            <Label>\n              Evidence {requiresEvidence ? \"*\" : \"(optional)\"}\n            </Label>\n            <div className=\"border-2 border-dashed rounded-lg p-4 text-center\">\n              <input\n                ref={fileInputRef}\n                type=\"file\"\n                multiple\n                onChange={handleFileChange}\n                className=\"hidden\"\n              />\n              <Button\n                type=\"button\"\n                variant=\"outline\"\n                onClick={() => fileInputRef.current?.click()}\n              >\n                <Upload className=\"mr-2 h-4 w-4\" />\n                Upload Evidence\n              </Button>\n              <p className=\"text-xs text-muted-foreground mt-2\">\n                Attach emails, approvals, or supporting documents\n              </p>\n            </div>\n            {files.length > 0 && (\n              <div className=\"flex flex-wrap gap-2 mt-2\">\n                {files.map((file, index) => (\n                  <Badge key={index} variant=\"secondary\" className=\"gap-1\">\n                    <Paperclip className=\"h-3 w-3\" />\n                    {file.name}\n                    <button\n                      type=\"button\"\n                      onClick={() => removeFile(index)}\n                      className=\"ml-1 hover:text-destructive\"\n                    >\n                      <XCircle className=\"h-3 w-3\" />\n                    </button>\n                  </Badge>\n                ))}\n              </div>\n            )}\n          </div>\n\n          {/* Requestor Info */}\n          <div className=\"rounded-lg bg-muted p-3 text-sm\">\n            <p className=\"text-xs text-muted-foreground mb-1\">Requesting As</p>\n            <div className=\"flex items-center gap-2\">\n              <User className=\"h-4 w-4\" />\n              <span className=\"font-medium\">{currentUser.name}</span>\n              <span className=\"text-muted-foreground\">({currentUser.role})</span>\n            </div>\n          </div>\n\n          {/* Warning */}\n          <div className=\"flex items-start gap-2 rounded-lg border border-amber-200 bg-amber-50 dark:bg-amber-950 p-3 text-sm\">\n            <AlertTriangle className=\"h-4 w-4 text-amber-600 shrink-0 mt-0.5\" />\n            <div className=\"text-amber-800 dark:text-amber-200\">\n              <p className=\"font-medium\">This action will be logged</p>\n              <p className=\"text-xs\">\n                A permanent, immutable record will be created. This cannot be undone or modified.\n              </p>\n            </div>\n          </div>\n        </CardContent>\n\n        <CardFooter className=\"gap-2 justify-end\">\n          {onCancel && (\n            <Button type=\"button\" variant=\"outline\" onClick={onCancel}>\n              Cancel\n            </Button>\n          )}\n          <Button type=\"submit\" disabled={!isValid || isSubmitting}>\n            {isSubmitting ? (\n              <>\n                <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                Submitting...\n              </>\n            ) : (\n              <>\n                <FileText className=\"mr-2 h-4 w-4\" />\n                Submit Override Request\n              </>\n            )}\n          </Button>\n        </CardFooter>\n      </form>\n    </Card>\n  )\n}\n\n// ============================================================================\n// Exports\n// ============================================================================\n\nexport { DEFAULT_REASONS }\nexport type { OverrideStatus, PolicyOverrideData }\n// OverrideReason is re-exported from blocks/types.ts\n"
    }
  ]
}