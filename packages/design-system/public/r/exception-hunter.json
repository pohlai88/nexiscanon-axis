{
  "$schema": "https://ui.shadcn.com/schema/registry-item.json",
  "name": "exception-hunter",
  "type": "registry:block",
  "title": "Exception Hunter (Quorum)",
  "description": "AI-powered exception detection and analysis with severity classification, suggested actions, and trend visualization",
  "categories": [
    "quorum",
    "analysis",
    "ai"
  ],
  "registryDependencies": [
    "card",
    "badge",
    "collapsible",
    "button"
  ],
  "dependencies": [],
  "devDependencies": [],
  "files": [
    {
      "path": "src/blocks/quorum/exception-hunter.tsx",
      "type": "registry:component",
      "content": "\"use client\"\n\n/**\n * Exception Hunter - Quorum Kernel Component\n *\n * AI-powered exception detection and drill-down analysis.\n * Implements A01-CANONICAL.md §4 — \"Surface the truth before they ask\"\n *\n * Features:\n * - Automatic anomaly detection\n * - Severity classification\n * - Drill-down investigation\n * - Related exceptions grouping\n * - Action recommendations\n *\n * @example\n * ```tsx\n * import { ExceptionHunter } from \"@workspace/design-system\"\n *\n * <ExceptionHunter\n *   exceptions={detectedExceptions}\n *   onInvestigate={(id) => drillDown(id)}\n *   onResolve={(id, action) => resolveException(id, action)}\n * />\n * ```\n */\n\nimport * as React from \"react\"\nimport { cn } from \"@/lib/utils\"\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/card\"\nimport { Badge } from \"@/components/badge\"\nimport { Button } from \"@/components/button\"\nimport { Progress } from \"@/components/progress\"\nimport {\n  Collapsible,\n  CollapsibleContent,\n  CollapsibleTrigger,\n} from \"@/components/collapsible\"\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n} from \"@/components/dropdown-menu\"\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/tooltip\"\nimport {\n  AlertTriangle,\n  AlertCircle,\n  Info,\n  XCircle,\n  ChevronDown,\n  ChevronRight,\n  Search,\n  Zap,\n  TrendingUp,\n  TrendingDown,\n  MoreVertical,\n  CheckCircle,\n  Eye,\n  Flag,\n  Clock,\n  ArrowRight,\n  Sparkles,\n  FileText,\n  Users,\n  DollarSign,\n} from \"lucide-react\"\n\n// ============================================================================\n// Types\n// ============================================================================\n\nexport type ExceptionSeverity = \"critical\" | \"high\" | \"medium\" | \"low\" | \"info\"\nexport type ExceptionCategory = \"financial\" | \"operational\" | \"compliance\" | \"security\" | \"data_quality\"\nexport type ExceptionStatus = \"open\" | \"investigating\" | \"resolved\" | \"dismissed\"\n\nexport interface ExceptionTrend {\n  direction: \"up\" | \"down\" | \"stable\"\n  percentage: number\n  period: string\n}\n\nexport interface RelatedEntity {\n  id: string\n  type: string\n  label: string\n  href?: string\n}\n\nexport interface SuggestedAction {\n  id: string\n  label: string\n  description?: string\n  type: \"auto_fix\" | \"investigate\" | \"escalate\" | \"dismiss\"\n  confidence?: number\n}\n\nexport interface Exception {\n  id: string\n  title: string\n  description: string\n  severity: ExceptionSeverity\n  category: ExceptionCategory\n  status: ExceptionStatus\n  detectedAt: string | Date\n  value?: number | string\n  expectedValue?: number | string\n  threshold?: number | string\n  trend?: ExceptionTrend\n  relatedEntities?: RelatedEntity[]\n  suggestedActions?: SuggestedAction[]\n  affectedCount?: number\n  metadata?: Record<string, unknown>\n}\n\nexport interface ExceptionHunterProps {\n  /** List of detected exceptions */\n  exceptions: Exception[]\n  /** Investigate callback */\n  onInvestigate?: (id: string) => void\n  /** Resolve callback */\n  onResolve?: (id: string, actionId: string) => Promise<void>\n  /** Dismiss callback */\n  onDismiss?: (id: string, reason?: string) => void\n  /** Escalate callback */\n  onEscalate?: (id: string) => void\n  /** View entity callback */\n  onViewEntity?: (entity: RelatedEntity) => void\n  /** Show AI recommendations */\n  showAIRecommendations?: boolean\n  /** Filter by severity */\n  severityFilter?: ExceptionSeverity[]\n  /** Filter by category */\n  categoryFilter?: ExceptionCategory[]\n  /** Group by category */\n  groupByCategory?: boolean\n  /** Custom className */\n  className?: string\n}\n\n// ============================================================================\n// Constants\n// ============================================================================\n\nconst SEVERITY_CONFIG: Record<\n  ExceptionSeverity,\n  {\n    icon: React.ComponentType<{ className?: string }>\n    color: string\n    bgColor: string\n    borderColor: string\n    label: string\n  }\n> = {\n  critical: {\n    icon: XCircle,\n    color: \"text-red-700\",\n    bgColor: \"bg-red-100 dark:bg-red-950\",\n    borderColor: \"border-red-300 dark:border-red-800\",\n    label: \"Critical\",\n  },\n  high: {\n    icon: AlertTriangle,\n    color: \"text-red-600\",\n    bgColor: \"bg-red-50 dark:bg-red-950/50\",\n    borderColor: \"border-red-200 dark:border-red-900\",\n    label: \"High\",\n  },\n  medium: {\n    icon: AlertCircle,\n    color: \"text-amber-600\",\n    bgColor: \"bg-amber-50 dark:bg-amber-950/50\",\n    borderColor: \"border-amber-200 dark:border-amber-900\",\n    label: \"Medium\",\n  },\n  low: {\n    icon: Info,\n    color: \"text-blue-600\",\n    bgColor: \"bg-blue-50 dark:bg-blue-950/50\",\n    borderColor: \"border-blue-200 dark:border-blue-900\",\n    label: \"Low\",\n  },\n  info: {\n    icon: Info,\n    color: \"text-gray-600\",\n    bgColor: \"bg-gray-50 dark:bg-gray-900\",\n    borderColor: \"border-gray-200 dark:border-gray-800\",\n    label: \"Info\",\n  },\n}\n\nconst CATEGORY_CONFIG: Record<ExceptionCategory, { icon: React.ComponentType<{ className?: string }>; label: string }> = {\n  financial: { icon: DollarSign, label: \"Financial\" },\n  operational: { icon: Zap, label: \"Operational\" },\n  compliance: { icon: Flag, label: \"Compliance\" },\n  security: { icon: AlertTriangle, label: \"Security\" },\n  data_quality: { icon: FileText, label: \"Data Quality\" },\n}\n\nconst STATUS_CONFIG: Record<ExceptionStatus, { color: string; label: string }> = {\n  open: { color: \"bg-red-100 text-red-700\", label: \"Open\" },\n  investigating: { color: \"bg-amber-100 text-amber-700\", label: \"Investigating\" },\n  resolved: { color: \"bg-green-100 text-green-700\", label: \"Resolved\" },\n  dismissed: { color: \"bg-gray-100 text-gray-700\", label: \"Dismissed\" },\n}\n\n// ============================================================================\n// Sub-components\n// ============================================================================\n\nfunction SeverityBadge({ severity }: { severity: ExceptionSeverity }) {\n  const config = SEVERITY_CONFIG[severity]\n  const Icon = config.icon\n  return (\n    <Badge className={cn(\"gap-1\", config.bgColor, config.color, \"border-0\")}>\n      <Icon className=\"h-3 w-3\" />\n      {config.label}\n    </Badge>\n  )\n}\n\nfunction TrendIndicator({ trend }: { trend: ExceptionTrend }) {\n  const isUp = trend.direction === \"up\"\n  const Icon = isUp ? TrendingUp : trend.direction === \"down\" ? TrendingDown : null\n\n  return (\n    <TooltipProvider>\n      <Tooltip>\n        <TooltipTrigger>\n          <span\n            className={cn(\n              \"inline-flex items-center gap-1 text-xs\",\n              isUp ? \"text-red-600\" : \"text-green-600\"\n            )}\n          >\n            {Icon && <Icon className=\"h-3 w-3\" />}\n            {trend.percentage > 0 && (isUp ? \"+\" : \"-\")}\n            {trend.percentage}%\n          </span>\n        </TooltipTrigger>\n        <TooltipContent>\n          <p>\n            {isUp ? \"Increased\" : \"Decreased\"} {trend.percentage}% over {trend.period}\n          </p>\n        </TooltipContent>\n      </Tooltip>\n    </TooltipProvider>\n  )\n}\n\nfunction ExceptionCard({\n  exception,\n  onInvestigate,\n  onResolve,\n  onDismiss,\n  onEscalate,\n  onViewEntity,\n  showAIRecommendations,\n}: {\n  exception: Exception\n  onInvestigate?: (id: string) => void\n  onResolve?: (id: string, actionId: string) => Promise<void>\n  onDismiss?: (id: string) => void\n  onEscalate?: (id: string) => void\n  onViewEntity?: (entity: RelatedEntity) => void\n  showAIRecommendations: boolean\n}) {\n  const [isExpanded, setIsExpanded] = React.useState(false)\n  const [isResolving, setIsResolving] = React.useState<string | null>(null)\n\n  const severityConfig = SEVERITY_CONFIG[exception.severity]\n  const categoryConfig = CATEGORY_CONFIG[exception.category]\n  const CategoryIcon = categoryConfig.icon\n\n  const handleResolve = async (actionId: string) => {\n    if (!onResolve) return\n    setIsResolving(actionId)\n    try {\n      await onResolve(exception.id, actionId)\n    } finally {\n      setIsResolving(null)\n    }\n  }\n\n  return (\n    <Collapsible open={isExpanded} onOpenChange={setIsExpanded}>\n      <Card\n        className={cn(\n          \"transition-all\",\n          severityConfig.borderColor,\n          exception.severity === \"critical\" && \"animate-pulse border-2\"\n        )}\n      >\n        <CardContent className=\"p-4\">\n          {/* Header */}\n          <div className=\"flex items-start gap-3\">\n            <CollapsibleTrigger>\n              <Button variant=\"ghost\" size=\"sm\" className=\"h-6 w-6 p-0 shrink-0\">\n                {isExpanded ? (\n                  <ChevronDown className=\"h-4 w-4\" />\n                ) : (\n                  <ChevronRight className=\"h-4 w-4\" />\n                )}\n              </Button>\n            </CollapsibleTrigger>\n\n            <div className=\"flex-1 min-w-0\">\n              <div className=\"flex items-start justify-between gap-2\">\n                <div className=\"flex-1\">\n                  <div className=\"flex items-center gap-2 flex-wrap\">\n                    <SeverityBadge severity={exception.severity} />\n                    <Badge variant=\"outline\" className=\"gap-1\">\n                      <CategoryIcon className=\"h-3 w-3\" />\n                      {categoryConfig.label}\n                    </Badge>\n                    <Badge className={STATUS_CONFIG[exception.status].color}>\n                      {STATUS_CONFIG[exception.status].label}\n                    </Badge>\n                    {exception.trend && <TrendIndicator trend={exception.trend} />}\n                  </div>\n                  <h4 className=\"mt-2 font-semibold\">{exception.title}</h4>\n                  <p className=\"text-sm text-muted-foreground\">{exception.description}</p>\n                </div>\n\n                {/* Quick Stats */}\n                <div className=\"text-right shrink-0\">\n                  {exception.value !== undefined && (\n                    <div>\n                      <span className=\"text-lg font-bold\">{exception.value}</span>\n                      {exception.expectedValue !== undefined && (\n                        <span className=\"text-sm text-muted-foreground\">\n                          {\" \"}\n                          / {exception.expectedValue}\n                        </span>\n                      )}\n                    </div>\n                  )}\n                  {exception.affectedCount !== undefined && (\n                    <p className=\"text-xs text-muted-foreground\">\n                      {exception.affectedCount} affected\n                    </p>\n                  )}\n                </div>\n              </div>\n\n              {/* Meta Info */}\n              <div className=\"mt-2 flex items-center gap-4 text-xs text-muted-foreground\">\n                <span className=\"flex items-center gap-1\">\n                  <Clock className=\"h-3 w-3\" />\n                  {new Date(exception.detectedAt).toLocaleString()}\n                </span>\n                {exception.relatedEntities && exception.relatedEntities.length > 0 && (\n                  <span className=\"flex items-center gap-1\">\n                    <Users className=\"h-3 w-3\" />\n                    {exception.relatedEntities.length} related\n                  </span>\n                )}\n              </div>\n            </div>\n\n            {/* Actions Menu */}\n            <DropdownMenu>\n              <DropdownMenuTrigger>\n                <Button variant=\"ghost\" size=\"sm\" className=\"h-8 w-8 p-0\">\n                  <MoreVertical className=\"h-4 w-4\" />\n                </Button>\n              </DropdownMenuTrigger>\n              <DropdownMenuContent align=\"end\">\n                <DropdownMenuItem onClick={() => onInvestigate?.(exception.id)}>\n                  <Search className=\"mr-2 h-4 w-4\" />\n                  Investigate\n                </DropdownMenuItem>\n                <DropdownMenuItem onClick={() => onEscalate?.(exception.id)}>\n                  <Flag className=\"mr-2 h-4 w-4\" />\n                  Escalate\n                </DropdownMenuItem>\n                <DropdownMenuSeparator />\n                <DropdownMenuItem onClick={() => onDismiss?.(exception.id)}>\n                  <XCircle className=\"mr-2 h-4 w-4\" />\n                  Dismiss\n                </DropdownMenuItem>\n              </DropdownMenuContent>\n            </DropdownMenu>\n          </div>\n\n          {/* Expanded Content */}\n          <CollapsibleContent className=\"mt-4 space-y-4\">\n            {/* Related Entities */}\n            {exception.relatedEntities && exception.relatedEntities.length > 0 && (\n              <div>\n                <h5 className=\"text-sm font-medium mb-2\">Related Entities</h5>\n                <div className=\"flex flex-wrap gap-2\">\n                  {exception.relatedEntities.map((entity) => (\n                    <Button\n                      key={entity.id}\n                      variant=\"outline\"\n                      size=\"sm\"\n                      className=\"text-xs\"\n                      onClick={() => onViewEntity?.(entity)}\n                    >\n                      {entity.type}: {entity.label}\n                      <ArrowRight className=\"ml-1 h-3 w-3\" />\n                    </Button>\n                  ))}\n                </div>\n              </div>\n            )}\n\n            {/* AI Recommendations */}\n            {showAIRecommendations &&\n              exception.suggestedActions &&\n              exception.suggestedActions.length > 0 && (\n                <div>\n                  <h5 className=\"text-sm font-medium mb-2 flex items-center gap-2\">\n                    <Sparkles className=\"h-4 w-4 text-primary\" />\n                    AI Recommendations\n                  </h5>\n                  <div className=\"space-y-2\">\n                    {exception.suggestedActions.map((action) => (\n                      <div\n                        key={action.id}\n                        className=\"flex items-center justify-between rounded-lg border p-3\"\n                      >\n                        <div className=\"flex-1\">\n                          <p className=\"font-medium text-sm\">{action.label}</p>\n                          {action.description && (\n                            <p className=\"text-xs text-muted-foreground\">\n                              {action.description}\n                            </p>\n                          )}\n                        </div>\n                        {action.confidence !== undefined && (\n                          <Badge variant=\"secondary\" className=\"mr-2\">\n                            {action.confidence}% confident\n                          </Badge>\n                        )}\n                        <Button\n                          size=\"sm\"\n                          variant={action.type === \"auto_fix\" ? \"default\" : \"outline\"}\n                          onClick={() => handleResolve(action.id)}\n                          disabled={isResolving === action.id}\n                        >\n                          {isResolving === action.id ? (\n                            <Clock className=\"mr-1 h-3 w-3 animate-spin\" />\n                          ) : action.type === \"auto_fix\" ? (\n                            <Zap className=\"mr-1 h-3 w-3\" />\n                          ) : (\n                            <CheckCircle className=\"mr-1 h-3 w-3\" />\n                          )}\n                          {action.type === \"auto_fix\" ? \"Auto Fix\" : \"Apply\"}\n                        </Button>\n                      </div>\n                    ))}\n                  </div>\n                </div>\n              )}\n\n            {/* Quick Actions */}\n            <div className=\"flex gap-2 pt-2\">\n              <Button size=\"sm\" onClick={() => onInvestigate?.(exception.id)}>\n                <Eye className=\"mr-1 h-3 w-3\" />\n                Drill Down\n              </Button>\n              <Button\n                size=\"sm\"\n                variant=\"outline\"\n                onClick={() => onDismiss?.(exception.id)}\n              >\n                Mark as False Positive\n              </Button>\n            </div>\n          </CollapsibleContent>\n        </CardContent>\n      </Card>\n    </Collapsible>\n  )\n}\n\n// ============================================================================\n// Summary Stats\n// ============================================================================\n\nfunction ExceptionSummary({ exceptions }: { exceptions: Exception[] }) {\n  const openCount = exceptions.filter((e) => e.status === \"open\").length\n  const criticalCount = exceptions.filter((e) => e.severity === \"critical\" && e.status === \"open\").length\n  const highCount = exceptions.filter((e) => e.severity === \"high\" && e.status === \"open\").length\n\n  return (\n    <div className=\"grid gap-4 md:grid-cols-4\">\n      <Card className=\"p-4\">\n        <div className=\"flex items-center gap-2\">\n          <AlertTriangle className=\"h-4 w-4 text-muted-foreground\" />\n          <span className=\"text-sm text-muted-foreground\">Total Open</span>\n        </div>\n        <p className=\"mt-2 text-2xl font-bold\">{openCount}</p>\n      </Card>\n      <Card className={cn(\"p-4\", criticalCount > 0 && \"border-red-300 bg-red-50 dark:bg-red-950/50\")}>\n        <div className=\"flex items-center gap-2\">\n          <XCircle className={cn(\"h-4 w-4\", criticalCount > 0 ? \"text-red-600\" : \"text-muted-foreground\")} />\n          <span className={cn(\"text-sm\", criticalCount > 0 ? \"text-red-700\" : \"text-muted-foreground\")}>Critical</span>\n        </div>\n        <p className={cn(\"mt-2 text-2xl font-bold\", criticalCount > 0 && \"text-red-700\")}>{criticalCount}</p>\n      </Card>\n      <Card className={cn(\"p-4\", highCount > 0 && \"border-amber-300 bg-amber-50 dark:bg-amber-950/50\")}>\n        <div className=\"flex items-center gap-2\">\n          <AlertTriangle className={cn(\"h-4 w-4\", highCount > 0 ? \"text-amber-600\" : \"text-muted-foreground\")} />\n          <span className={cn(\"text-sm\", highCount > 0 ? \"text-amber-700\" : \"text-muted-foreground\")}>High</span>\n        </div>\n        <p className={cn(\"mt-2 text-2xl font-bold\", highCount > 0 && \"text-amber-700\")}>{highCount}</p>\n      </Card>\n      <Card className=\"p-4\">\n        <div className=\"flex items-center gap-2\">\n          <CheckCircle className=\"h-4 w-4 text-green-600\" />\n          <span className=\"text-sm text-muted-foreground\">Resolution Rate</span>\n        </div>\n        <p className=\"mt-2 text-2xl font-bold text-green-600\">\n          {exceptions.length > 0\n            ? Math.round(\n                (exceptions.filter((e) => e.status === \"resolved\").length / exceptions.length) * 100\n              )\n            : 100}\n          %\n        </p>\n      </Card>\n    </div>\n  )\n}\n\n// ============================================================================\n// Main Component\n// ============================================================================\n\nexport function ExceptionHunter({\n  exceptions,\n  onInvestigate,\n  onResolve,\n  onDismiss,\n  onEscalate,\n  onViewEntity,\n  showAIRecommendations = true,\n  severityFilter,\n  categoryFilter,\n  groupByCategory = false,\n  className,\n}: ExceptionHunterProps) {\n  // Filter exceptions\n  const filteredExceptions = React.useMemo(() => {\n    let result = exceptions\n\n    if (severityFilter && severityFilter.length > 0) {\n      result = result.filter((e) => severityFilter.includes(e.severity))\n    }\n\n    if (categoryFilter && categoryFilter.length > 0) {\n      result = result.filter((e) => categoryFilter.includes(e.category))\n    }\n\n    // Sort by severity (critical first) and date\n    return result.sort((a, b) => {\n      const severityOrder: ExceptionSeverity[] = [\"critical\", \"high\", \"medium\", \"low\", \"info\"]\n      const severityDiff = severityOrder.indexOf(a.severity) - severityOrder.indexOf(b.severity)\n      if (severityDiff !== 0) return severityDiff\n      return new Date(b.detectedAt).getTime() - new Date(a.detectedAt).getTime()\n    })\n  }, [exceptions, severityFilter, categoryFilter])\n\n  // Group by category if requested\n  const groupedExceptions = React.useMemo(() => {\n    if (!groupByCategory) return null\n\n    const groups: Record<ExceptionCategory, Exception[]> = {\n      financial: [],\n      operational: [],\n      compliance: [],\n      security: [],\n      data_quality: [],\n    }\n\n    filteredExceptions.forEach((e) => {\n      groups[e.category].push(e)\n    })\n\n    return Object.entries(groups).filter(([, items]) => items.length > 0)\n  }, [filteredExceptions, groupByCategory])\n\n  return (\n    <Card className={className}>\n      <CardHeader>\n        <CardTitle className=\"flex items-center gap-2\">\n          <Search className=\"h-5 w-5\" />\n          Exception Hunter\n        </CardTitle>\n        <CardDescription>\n          AI-powered anomaly detection and investigation\n        </CardDescription>\n      </CardHeader>\n      <CardContent className=\"space-y-6\">\n        {/* Summary Stats */}\n        <ExceptionSummary exceptions={exceptions} />\n\n        {/* Exception List */}\n        {filteredExceptions.length === 0 ? (\n          <div className=\"flex flex-col items-center justify-center py-12 text-center\">\n            <CheckCircle className=\"h-12 w-12 text-green-500\" />\n            <h3 className=\"mt-4 font-semibold\">All Clear!</h3>\n            <p className=\"text-sm text-muted-foreground\">No exceptions detected</p>\n          </div>\n        ) : groupByCategory && groupedExceptions ? (\n          <div className=\"space-y-6\">\n            {groupedExceptions.map(([category, items]) => {\n              const config = CATEGORY_CONFIG[category as ExceptionCategory]\n              const Icon = config.icon\n              return (\n                <div key={category}>\n                  <h3 className=\"flex items-center gap-2 mb-3 font-semibold\">\n                    <Icon className=\"h-4 w-4\" />\n                    {config.label}\n                    <Badge variant=\"secondary\">{items.length}</Badge>\n                  </h3>\n                  <div className=\"space-y-3\">\n                    {items.map((exception) => (\n                      <ExceptionCard\n                        key={exception.id}\n                        exception={exception}\n                        onInvestigate={onInvestigate}\n                        onResolve={onResolve}\n                        onDismiss={onDismiss}\n                        onEscalate={onEscalate}\n                        onViewEntity={onViewEntity}\n                        showAIRecommendations={showAIRecommendations}\n                      />\n                    ))}\n                  </div>\n                </div>\n              )\n            })}\n          </div>\n        ) : (\n          <div className=\"space-y-3\">\n            {filteredExceptions.map((exception) => (\n              <ExceptionCard\n                key={exception.id}\n                exception={exception}\n                onInvestigate={onInvestigate}\n                onResolve={onResolve}\n                onDismiss={onDismiss}\n                onEscalate={onEscalate}\n                onViewEntity={onViewEntity}\n                showAIRecommendations={showAIRecommendations}\n              />\n            ))}\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  )\n}\n\n// ============================================================================\n// Exports\n// ============================================================================\n\nexport type {\n  ExceptionSeverity,\n  ExceptionCategory,\n  ExceptionStatus,\n  ExceptionTrend,\n  RelatedEntity,\n  SuggestedAction,\n  Exception,\n}\n"
    }
  ]
}