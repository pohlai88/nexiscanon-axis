{
  "$schema": "https://ui.shadcn.com/schema/registry-item.json",
  "name": "approval-queue",
  "type": "registry:block",
  "title": "Approval Queue (AFANDA)",
  "description": "Hierarchical approval workflow with SLA timers, bulk actions, comments, and delegation support",
  "categories": [
    "afanda",
    "collaboration",
    "workflow"
  ],
  "registryDependencies": [
    "card",
    "button",
    "badge",
    "avatar",
    "tooltip"
  ],
  "dependencies": [],
  "devDependencies": [],
  "files": [
    {
      "path": "src/blocks/afanda/approval-queue.tsx",
      "type": "registry:component",
      "content": "\"use client\"\n\n/**\n * Approval Queue - AFANDA Platform Component\n *\n * Hierarchical approval workflow with SLA timers.\n * Implements A01-CANONICAL.md §8 — AFANDA (Unified Board)\n *\n * Features:\n * - SLA countdown timers\n * - Auto-escalation on breach\n * - Approval chain visualization\n * - Bulk approve/reject\n * - Evidence attachment\n *\n * @example\n * ```tsx\n * import { ApprovalQueue } from \"@workspace/design-system\"\n *\n * <ApprovalQueue\n *   items={approvalItems}\n *   onApprove={(id, comment) => handleApprove(id, comment)}\n *   onReject={(id, reason) => handleReject(id, reason)}\n *   onEscalate={(id) => handleEscalate(id)}\n * />\n * ```\n */\n\nimport * as React from \"react\"\nimport { cn } from \"@/lib/utils\"\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/card\"\nimport { Badge } from \"@/components/badge\"\nimport { Button } from \"@/components/button\"\nimport { Checkbox } from \"@/components/checkbox\"\nimport { Textarea } from \"@/components/textarea\"\nimport { Avatar } from \"@/components/avatar\"\nimport { Separator } from \"@/components/separator\"\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/dialog\"\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n} from \"@/components/dropdown-menu\"\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/tooltip\"\nimport {\n  CheckCircle,\n  XCircle,\n  Clock,\n  AlertTriangle,\n  ArrowUp,\n  MoreVertical,\n  FileText,\n  User,\n  Calendar,\n  DollarSign,\n  Loader2,\n  ChevronDown,\n  ChevronRight,\n  Eye,\n  MessageSquare,\n} from \"lucide-react\"\n\n// ============================================================================\n// Types\n// ============================================================================\n\nexport type ApprovalStatus = \"pending\" | \"approved\" | \"rejected\" | \"escalated\"\nexport type ApprovalPriority = \"low\" | \"normal\" | \"high\" | \"urgent\"\nexport type DocumentType = \"invoice\" | \"purchase_order\" | \"expense\" | \"leave\" | \"other\"\n\nexport interface ApprovalActor {\n  id: string\n  name: string\n  email?: string\n  role?: string\n  avatarUrl?: string\n}\n\nexport interface ApprovalItem {\n  id: string\n  type: DocumentType\n  documentNumber: string\n  title: string\n  description?: string\n  amount?: number\n  currency?: string\n  requester: ApprovalActor\n  currentApprover: ApprovalActor\n  approvalChain?: ApprovalActor[]\n  status: ApprovalStatus\n  priority: ApprovalPriority\n  createdAt: string | Date\n  dueAt: string | Date\n  slaHours: number\n  attachments?: { id: string; name: string; url: string }[]\n  metadata?: Record<string, unknown>\n}\n\nexport interface ApprovalQueueProps {\n  /** List of approval items */\n  items: ApprovalItem[]\n  /** Approve callback */\n  onApprove?: (id: string, comment?: string) => Promise<void>\n  /** Reject callback */\n  onReject?: (id: string, reason: string) => Promise<void>\n  /** Escalate callback */\n  onEscalate?: (id: string) => Promise<void>\n  /** View details callback */\n  onViewDetails?: (item: ApprovalItem) => void\n  /** Bulk approve callback */\n  onBulkApprove?: (ids: string[], comment?: string) => Promise<void>\n  /** Bulk reject callback */\n  onBulkReject?: (ids: string[], reason: string) => Promise<void>\n  /** Show SLA timers */\n  showSLA?: boolean\n  /** Allow bulk actions */\n  allowBulkActions?: boolean\n  /** Custom className */\n  className?: string\n}\n\n// ============================================================================\n// Helpers\n// ============================================================================\n\nfunction formatCurrency(amount: number, currency: string = \"USD\"): string {\n  return new Intl.NumberFormat(\"en-US\", {\n    style: \"currency\",\n    currency,\n  }).format(amount)\n}\n\nfunction formatRelativeTime(date: string | Date): string {\n  const d = typeof date === \"string\" ? new Date(date) : date\n  const now = new Date()\n  const diffMs = d.getTime() - now.getTime()\n  const diffHours = Math.floor(diffMs / (1000 * 60 * 60))\n  const diffMins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60))\n\n  if (diffMs < 0) {\n    const absDiffHours = Math.abs(diffHours)\n    if (absDiffHours > 24) {\n      return `${Math.floor(absDiffHours / 24)}d overdue`\n    }\n    return `${absDiffHours}h overdue`\n  }\n\n  if (diffHours > 24) {\n    return `${Math.floor(diffHours / 24)}d ${diffHours % 24}h`\n  }\n  if (diffHours > 0) {\n    return `${diffHours}h ${diffMins}m`\n  }\n  return `${diffMins}m`\n}\n\nfunction getSLAStatus(dueAt: string | Date): \"safe\" | \"warning\" | \"critical\" | \"overdue\" {\n  const due = typeof dueAt === \"string\" ? new Date(dueAt) : dueAt\n  const now = new Date()\n  const diffHours = (due.getTime() - now.getTime()) / (1000 * 60 * 60)\n\n  if (diffHours < 0) return \"overdue\"\n  if (diffHours < 2) return \"critical\"\n  if (diffHours < 8) return \"warning\"\n  return \"safe\"\n}\n\n// ============================================================================\n// Sub-components\n// ============================================================================\n\nfunction SLATimer({ dueAt }: { dueAt: string | Date }) {\n  const [timeLeft, setTimeLeft] = React.useState(formatRelativeTime(dueAt))\n  const [status, setStatus] = React.useState(getSLAStatus(dueAt))\n\n  React.useEffect(() => {\n    const interval = setInterval(() => {\n      setTimeLeft(formatRelativeTime(dueAt))\n      setStatus(getSLAStatus(dueAt))\n    }, 60000) // Update every minute\n\n    return () => clearInterval(interval)\n  }, [dueAt])\n\n  const colors: Record<typeof status, string> = {\n    safe: \"text-green-600 bg-green-50 dark:bg-green-950\",\n    warning: \"text-amber-600 bg-amber-50 dark:bg-amber-950\",\n    critical: \"text-red-600 bg-red-50 dark:bg-red-950 animate-pulse\",\n    overdue: \"text-red-700 bg-red-100 dark:bg-red-900\",\n  }\n\n  return (\n    <TooltipProvider>\n      <Tooltip>\n        <TooltipTrigger>\n          <div\n            className={cn(\n              \"inline-flex items-center gap-1 rounded px-2 py-0.5 text-xs font-medium\",\n              colors[status]\n            )}\n          >\n            <Clock className=\"h-3 w-3\" />\n            {timeLeft}\n          </div>\n        </TooltipTrigger>\n        <TooltipContent>\n          {status === \"overdue\" && \"SLA breached - escalation required\"}\n          {status === \"critical\" && \"SLA expires soon - action required\"}\n          {status === \"warning\" && \"Approaching SLA deadline\"}\n          {status === \"safe\" && \"Within SLA timeline\"}\n        </TooltipContent>\n      </Tooltip>\n    </TooltipProvider>\n  )\n}\n\nfunction PriorityBadge({ priority }: { priority: ApprovalPriority }) {\n  const config: Record<ApprovalPriority, { label: string; variant: \"default\" | \"secondary\" | \"destructive\" | \"outline\" }> = {\n    low: { label: \"Low\", variant: \"outline\" },\n    normal: { label: \"Normal\", variant: \"secondary\" },\n    high: { label: \"High\", variant: \"default\" },\n    urgent: { label: \"Urgent\", variant: \"destructive\" },\n  }\n\n  return <Badge variant={config[priority].variant}>{config[priority].label}</Badge>\n}\n\nfunction DocumentTypeBadge({ type }: { type: DocumentType }) {\n  const labels: Record<DocumentType, string> = {\n    invoice: \"Invoice\",\n    purchase_order: \"Purchase Order\",\n    expense: \"Expense\",\n    leave: \"Leave Request\",\n    other: \"Other\",\n  }\n\n  return (\n    <Badge variant=\"outline\" className=\"text-xs\">\n      {labels[type]}\n    </Badge>\n  )\n}\n\nfunction ActorAvatar({ actor }: { actor: ApprovalActor }) {\n  return (\n    <TooltipProvider>\n      <Tooltip>\n        <TooltipTrigger>\n          <Avatar className=\"h-8 w-8\">\n            {actor.avatarUrl ? (\n              <img src={actor.avatarUrl} alt={actor.name} />\n            ) : (\n              <div className=\"flex h-full w-full items-center justify-center bg-muted text-xs font-medium\">\n                {actor.name.charAt(0).toUpperCase()}\n              </div>\n            )}\n          </Avatar>\n        </TooltipTrigger>\n        <TooltipContent>\n          <p className=\"font-medium\">{actor.name}</p>\n          {actor.role && <p className=\"text-xs text-muted-foreground\">{actor.role}</p>}\n        </TooltipContent>\n      </Tooltip>\n    </TooltipProvider>\n  )\n}\n\n// ============================================================================\n// Approval Item Card\n// ============================================================================\n\nfunction ApprovalItemCard({\n  item,\n  selected,\n  onSelect,\n  onApprove,\n  onReject,\n  onEscalate,\n  onViewDetails,\n  showSLA,\n}: {\n  item: ApprovalItem\n  selected: boolean\n  onSelect: (selected: boolean) => void\n  onApprove: () => void\n  onReject: (reason: string) => void\n  onEscalate: () => void\n  onViewDetails: () => void\n  showSLA: boolean\n}) {\n  const [showRejectDialog, setShowRejectDialog] = React.useState(false)\n  const [showApproveDialog, setShowApproveDialog] = React.useState(false)\n  const [rejectReason, setRejectReason] = React.useState(\"\")\n  const [approveComment, setApproveComment] = React.useState(\"\")\n  const [isProcessing, setIsProcessing] = React.useState(false)\n  const [expanded, setExpanded] = React.useState(false)\n\n  const handleApprove = async () => {\n    setIsProcessing(true)\n    try {\n      onApprove()\n      setShowApproveDialog(false)\n    } finally {\n      setIsProcessing(false)\n    }\n  }\n\n  const handleReject = async () => {\n    if (!rejectReason.trim()) return\n    setIsProcessing(true)\n    try {\n      onReject(rejectReason)\n      setShowRejectDialog(false)\n      setRejectReason(\"\")\n    } finally {\n      setIsProcessing(false)\n    }\n  }\n\n  const slaStatus = getSLAStatus(item.dueAt)\n\n  return (\n    <>\n      <Card\n        className={cn(\n          \"transition-all\",\n          selected && \"ring-2 ring-primary\",\n          slaStatus === \"overdue\" && \"border-red-300 dark:border-red-800\",\n          slaStatus === \"critical\" && \"border-amber-300 dark:border-amber-800\"\n        )}\n      >\n        <CardContent className=\"p-4\">\n          <div className=\"flex items-start gap-3\">\n            <Checkbox\n              checked={selected}\n              onCheckedChange={onSelect}\n              className=\"mt-1\"\n            />\n\n            <div className=\"flex-1 min-w-0\">\n              {/* Header */}\n              <div className=\"flex items-start justify-between gap-2\">\n                <div className=\"flex-1 min-w-0\">\n                  <div className=\"flex items-center gap-2 flex-wrap\">\n                    <span className=\"font-semibold\">{item.documentNumber}</span>\n                    <DocumentTypeBadge type={item.type} />\n                    <PriorityBadge priority={item.priority} />\n                    {showSLA && <SLATimer dueAt={item.dueAt} />}\n                  </div>\n                  <h4 className=\"mt-1 font-medium\">{item.title}</h4>\n                  {item.description && (\n                    <p className=\"mt-0.5 text-sm text-muted-foreground line-clamp-2\">\n                      {item.description}\n                    </p>\n                  )}\n                </div>\n\n                {item.amount !== undefined && (\n                  <div className=\"text-right shrink-0\">\n                    <p className=\"text-lg font-bold\">\n                      {formatCurrency(item.amount, item.currency)}\n                    </p>\n                  </div>\n                )}\n              </div>\n\n              {/* Meta Info */}\n              <div className=\"mt-3 flex items-center gap-4 text-sm text-muted-foreground\">\n                <div className=\"flex items-center gap-1\">\n                  <User className=\"h-3 w-3\" />\n                  <span>From: {item.requester.name}</span>\n                </div>\n                <div className=\"flex items-center gap-1\">\n                  <Calendar className=\"h-3 w-3\" />\n                  <span>{new Date(item.createdAt).toLocaleDateString()}</span>\n                </div>\n                {item.attachments && item.attachments.length > 0 && (\n                  <div className=\"flex items-center gap-1\">\n                    <FileText className=\"h-3 w-3\" />\n                    <span>{item.attachments.length} attachment(s)</span>\n                  </div>\n                )}\n              </div>\n\n              {/* Approval Chain (Expandable) */}\n              {item.approvalChain && item.approvalChain.length > 0 && (\n                <div className=\"mt-3\">\n                  <button\n                    onClick={() => setExpanded(!expanded)}\n                    className=\"flex items-center gap-1 text-xs text-muted-foreground hover:text-foreground\"\n                  >\n                    {expanded ? <ChevronDown className=\"h-3 w-3\" /> : <ChevronRight className=\"h-3 w-3\" />}\n                    Approval Chain ({item.approvalChain.length} steps)\n                  </button>\n                  {expanded && (\n                    <div className=\"mt-2 flex items-center gap-2\">\n                      {item.approvalChain.map((actor, index) => (\n                        <React.Fragment key={actor.id}>\n                          <ActorAvatar actor={actor} />\n                          {index < item.approvalChain!.length - 1 && (\n                            <span className=\"text-muted-foreground\">→</span>\n                          )}\n                        </React.Fragment>\n                      ))}\n                    </div>\n                  )}\n                </div>\n              )}\n\n              {/* Actions */}\n              <div className=\"mt-4 flex items-center gap-2\">\n                <Button size=\"sm\" onClick={() => setShowApproveDialog(true)}>\n                  <CheckCircle className=\"mr-1 h-3 w-3\" />\n                  Approve\n                </Button>\n                <Button\n                  size=\"sm\"\n                  variant=\"outline\"\n                  onClick={() => setShowRejectDialog(true)}\n                >\n                  <XCircle className=\"mr-1 h-3 w-3\" />\n                  Reject\n                </Button>\n                <Button size=\"sm\" variant=\"ghost\" onClick={onViewDetails}>\n                  <Eye className=\"mr-1 h-3 w-3\" />\n                  View\n                </Button>\n                <DropdownMenu>\n                  <DropdownMenuTrigger>\n                    <Button size=\"sm\" variant=\"ghost\" className=\"h-8 w-8 p-0\">\n                      <MoreVertical className=\"h-4 w-4\" />\n                    </Button>\n                  </DropdownMenuTrigger>\n                  <DropdownMenuContent align=\"end\">\n                    <DropdownMenuItem onClick={onEscalate}>\n                      <ArrowUp className=\"mr-2 h-4 w-4\" />\n                      Escalate\n                    </DropdownMenuItem>\n                    <DropdownMenuItem onClick={onViewDetails}>\n                      <MessageSquare className=\"mr-2 h-4 w-4\" />\n                      Add Comment\n                    </DropdownMenuItem>\n                    <DropdownMenuSeparator />\n                    <DropdownMenuItem onClick={onViewDetails}>\n                      <FileText className=\"mr-2 h-4 w-4\" />\n                      View History\n                    </DropdownMenuItem>\n                  </DropdownMenuContent>\n                </DropdownMenu>\n              </div>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Approve Dialog */}\n      <Dialog open={showApproveDialog} onOpenChange={setShowApproveDialog}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Approve Request</DialogTitle>\n            <DialogDescription>\n              Approve {item.documentNumber}: {item.title}\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"py-4\">\n            <Textarea\n              placeholder=\"Add an optional comment...\"\n              value={approveComment}\n              onChange={(e) => setApproveComment(e.target.value)}\n              rows={3}\n            />\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowApproveDialog(false)}>\n              Cancel\n            </Button>\n            <Button onClick={handleApprove} disabled={isProcessing}>\n              {isProcessing ? (\n                <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n              ) : (\n                <CheckCircle className=\"mr-2 h-4 w-4\" />\n              )}\n              Approve\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Reject Dialog */}\n      <Dialog open={showRejectDialog} onOpenChange={setShowRejectDialog}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Reject Request</DialogTitle>\n            <DialogDescription>\n              Reject {item.documentNumber}: {item.title}\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"py-4\">\n            <Textarea\n              placeholder=\"Please provide a reason for rejection (required)...\"\n              value={rejectReason}\n              onChange={(e) => setRejectReason(e.target.value)}\n              rows={3}\n            />\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowRejectDialog(false)}>\n              Cancel\n            </Button>\n            <Button\n              variant=\"destructive\"\n              onClick={handleReject}\n              disabled={isProcessing || !rejectReason.trim()}\n            >\n              {isProcessing ? (\n                <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n              ) : (\n                <XCircle className=\"mr-2 h-4 w-4\" />\n              )}\n              Reject\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </>\n  )\n}\n\n// ============================================================================\n// Main Component\n// ============================================================================\n\nexport function ApprovalQueue({\n  items,\n  onApprove,\n  onReject,\n  onEscalate,\n  onViewDetails,\n  onBulkApprove,\n  onBulkReject,\n  showSLA = true,\n  allowBulkActions = true,\n  className,\n}: ApprovalQueueProps) {\n  const [selectedIds, setSelectedIds] = React.useState<Set<string>>(new Set())\n\n  const pendingItems = items.filter((item) => item.status === \"pending\")\n  const overdueItems = pendingItems.filter((item) => getSLAStatus(item.dueAt) === \"overdue\")\n\n  const toggleSelection = (id: string, selected: boolean) => {\n    setSelectedIds((prev) => {\n      const next = new Set(prev)\n      if (selected) {\n        next.add(id)\n      } else {\n        next.delete(id)\n      }\n      return next\n    })\n  }\n\n  const selectAll = () => {\n    setSelectedIds(new Set(pendingItems.map((item) => item.id)))\n  }\n\n  const clearSelection = () => {\n    setSelectedIds(new Set())\n  }\n\n  const handleApprove = async (id: string, comment?: string) => {\n    if (onApprove) {\n      await onApprove(id, comment)\n    }\n    setSelectedIds((prev) => {\n      const next = new Set(prev)\n      next.delete(id)\n      return next\n    })\n  }\n\n  const handleReject = async (id: string, reason: string) => {\n    if (onReject) {\n      await onReject(id, reason)\n    }\n    setSelectedIds((prev) => {\n      const next = new Set(prev)\n      next.delete(id)\n      return next\n    })\n  }\n\n  const handleBulkApprove = async () => {\n    if (onBulkApprove && selectedIds.size > 0) {\n      await onBulkApprove(Array.from(selectedIds))\n      clearSelection()\n    }\n  }\n\n  const handleBulkReject = async () => {\n    if (onBulkReject && selectedIds.size > 0) {\n      await onBulkReject(Array.from(selectedIds), \"Bulk rejection\")\n      clearSelection()\n    }\n  }\n\n  return (\n    <Card className={className}>\n      <CardHeader>\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Clock className=\"h-5 w-5\" />\n              Approval Queue\n            </CardTitle>\n            <CardDescription>\n              {pendingItems.length} pending • {overdueItems.length} overdue\n            </CardDescription>\n          </div>\n\n          {/* Bulk Actions */}\n          {allowBulkActions && selectedIds.size > 0 && (\n            <div className=\"flex items-center gap-2\">\n              <span className=\"text-sm text-muted-foreground\">\n                {selectedIds.size} selected\n              </span>\n              <Button size=\"sm\" onClick={handleBulkApprove}>\n                <CheckCircle className=\"mr-1 h-3 w-3\" />\n                Approve All\n              </Button>\n              <Button size=\"sm\" variant=\"outline\" onClick={clearSelection}>\n                Clear\n              </Button>\n            </div>\n          )}\n\n          {allowBulkActions && selectedIds.size === 0 && pendingItems.length > 0 && (\n            <Button variant=\"outline\" size=\"sm\" onClick={selectAll}>\n              Select All\n            </Button>\n          )}\n        </div>\n\n        {/* Overdue Alert */}\n        {overdueItems.length > 0 && (\n          <div className=\"mt-2 flex items-center gap-2 rounded-lg border border-red-200 bg-red-50 px-3 py-2 dark:border-red-800 dark:bg-red-950\">\n            <AlertTriangle className=\"h-4 w-4 text-red-600\" />\n            <span className=\"text-sm text-red-700 dark:text-red-300\">\n              {overdueItems.length} item(s) have breached SLA and require immediate attention\n            </span>\n          </div>\n        )}\n      </CardHeader>\n\n      <CardContent className=\"space-y-4\">\n        {pendingItems.length === 0 ? (\n          <div className=\"flex flex-col items-center justify-center py-12 text-center\">\n            <CheckCircle className=\"h-12 w-12 text-green-500\" />\n            <h3 className=\"mt-4 font-semibold\">All caught up!</h3>\n            <p className=\"text-sm text-muted-foreground\">\n              No pending approvals in your queue\n            </p>\n          </div>\n        ) : (\n          pendingItems.map((item) => (\n            <ApprovalItemCard\n              key={item.id}\n              item={item}\n              selected={selectedIds.has(item.id)}\n              onSelect={(selected) => toggleSelection(item.id, selected)}\n              onApprove={() => handleApprove(item.id)}\n              onReject={(reason) => handleReject(item.id, reason)}\n              onEscalate={() => onEscalate?.(item.id)}\n              onViewDetails={() => onViewDetails?.(item)}\n              showSLA={showSLA}\n            />\n          ))\n        )}\n      </CardContent>\n    </Card>\n  )\n}\n\n// ============================================================================\n// Exports\n// ============================================================================\n\nexport type { ApprovalStatus, ApprovalPriority, DocumentType, ApprovalActor, ApprovalItem }\n"
    }
  ]
}