{
  "$schema": "https://ui.shadcn.com/schema/registry-item.json",
  "name": "trend-analysis-widget",
  "type": "registry:block",
  "title": "Trend Analysis Widget (Quorum)",
  "description": "Multi-period trend comparison with anomaly highlighting, AI-generated insights, and configurable metrics",
  "categories": [
    "quorum",
    "analysis",
    "charts"
  ],
  "registryDependencies": [
    "card",
    "select",
    "tooltip"
  ],
  "dependencies": [
    "recharts"
  ],
  "devDependencies": [],
  "files": [
    {
      "path": "src/blocks/quorum/trend-analysis-widget.tsx",
      "type": "registry:component",
      "content": "\"use client\"\n\n/**\n * Trend Analysis Widget - Quorum Kernel Component\n *\n * Visualize trends over time with comparative analysis.\n * Implements A01-CANONICAL.md §4 — \"Surface the truth before they ask\"\n *\n * Features:\n * - Multi-period comparison\n * - Trend direction indicators\n * - Sparkline visualizations\n * - Anomaly highlighting\n * - Drill-down to details\n *\n * @example\n * ```tsx\n * import { TrendAnalysisWidget } from \"@workspace/design-system\"\n *\n * <TrendAnalysisWidget\n *   metrics={trendData}\n *   periods={[\"This Month\", \"Last Month\", \"Last Year\"]}\n *   onDrillDown={(metricId, period) => viewDetails(metricId, period)}\n * />\n * ```\n */\n\nimport * as React from \"react\"\nimport { cn } from \"@/lib/utils\"\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/card\"\nimport { Badge } from \"@/components/badge\"\nimport { Button } from \"@/components/button\"\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/select\"\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/tooltip\"\nimport {\n  TrendingUp,\n  TrendingDown,\n  Minus,\n  ArrowRight,\n  AlertTriangle,\n  Calendar,\n  RefreshCw,\n  Download,\n  Sparkles,\n  ChevronRight,\n} from \"lucide-react\"\n\n// ============================================================================\n// Types (TrendDirection imported from shared types to avoid conflicts)\n// ============================================================================\n\nimport type { TrendDirection } from \"../types\"\n\nexport interface TrendDataPoint {\n  period: string\n  value: number\n  label?: string\n}\n\nexport interface TrendMetric {\n  id: string\n  name: string\n  description?: string\n  currentValue: number\n  formattedValue: string\n  unit?: string\n  trend: {\n    direction: TrendDirection\n    percentage: number\n    isPositive: boolean // Whether this direction is good (e.g., revenue up = good, costs up = bad)\n  }\n  dataPoints: TrendDataPoint[]\n  comparisons?: {\n    period: string\n    value: number\n    formattedValue: string\n    change: number\n  }[]\n  anomaly?: {\n    detected: boolean\n    message: string\n    severity: \"info\" | \"warning\" | \"critical\"\n  }\n  aiInsight?: string\n}\n\nexport interface TrendAnalysisWidgetProps {\n  /** Trend metrics data */\n  metrics: TrendMetric[]\n  /** Available comparison periods */\n  periods?: string[]\n  /** Selected comparison period */\n  selectedPeriod?: string\n  /** Period change callback */\n  onPeriodChange?: (period: string) => void\n  /** Drill-down callback */\n  onDrillDown?: (metricId: string, period?: string) => void\n  /** Refresh callback */\n  onRefresh?: () => Promise<void>\n  /** Export callback */\n  onExport?: (format: \"csv\" | \"pdf\") => void\n  /** Show AI insights */\n  showAIInsights?: boolean\n  /** Compact mode */\n  compact?: boolean\n  /** Custom className */\n  className?: string\n}\n\n// ============================================================================\n// Helper Components\n// ============================================================================\n\nfunction MiniSparkline({\n  dataPoints,\n  trend,\n  width = 80,\n  height = 24,\n}: {\n  dataPoints: TrendDataPoint[]\n  trend: TrendMetric[\"trend\"]\n  width?: number\n  height?: number\n}) {\n  if (!dataPoints || dataPoints.length < 2) return null\n\n  const values = dataPoints.map((d) => d.value)\n  const max = Math.max(...values)\n  const min = Math.min(...values)\n  const range = max - min || 1\n\n  const points = values\n    .map((value, index) => {\n      const x = (index / (values.length - 1)) * width\n      const y = height - ((value - min) / range) * height\n      return `${x},${y}`\n    })\n    .join(\" \")\n\n  const color = trend.isPositive\n    ? trend.direction === \"up\"\n      ? \"#22c55e\"\n      : trend.direction === \"down\"\n      ? \"#ef4444\"\n      : \"#6b7280\"\n    : trend.direction === \"up\"\n    ? \"#ef4444\"\n    : trend.direction === \"down\"\n    ? \"#22c55e\"\n    : \"#6b7280\"\n\n  return (\n    <svg\n      width={width}\n      height={height}\n      viewBox={`0 0 ${width} ${height}`}\n      className=\"overflow-visible\"\n    >\n      <polyline\n        points={points}\n        fill=\"none\"\n        stroke={color}\n        strokeWidth=\"2\"\n        strokeLinecap=\"round\"\n        strokeLinejoin=\"round\"\n      />\n      {/* End point dot */}\n      <circle\n        cx={width}\n        cy={height - ((values[values.length - 1] - min) / range) * height}\n        r=\"3\"\n        fill={color}\n      />\n    </svg>\n  )\n}\n\nfunction TrendIndicator({\n  direction,\n  percentage,\n  isPositive,\n  size = \"default\",\n}: {\n  direction: TrendDirection\n  percentage: number\n  isPositive: boolean\n  size?: \"sm\" | \"default\" | \"lg\"\n}) {\n  const Icon = direction === \"up\" ? TrendingUp : direction === \"down\" ? TrendingDown : Minus\n\n  const isGood = (direction === \"up\" && isPositive) || (direction === \"down\" && !isPositive)\n  const isBad = (direction === \"up\" && !isPositive) || (direction === \"down\" && isPositive)\n\n  const sizes = {\n    sm: { icon: \"h-3 w-3\", text: \"text-xs\", padding: \"px-1.5 py-0.5\" },\n    default: { icon: \"h-4 w-4\", text: \"text-sm\", padding: \"px-2 py-1\" },\n    lg: { icon: \"h-5 w-5\", text: \"text-base\", padding: \"px-3 py-1.5\" },\n  }\n\n  const s = sizes[size]\n\n  return (\n    <span\n      className={cn(\n        \"inline-flex items-center gap-1 rounded-md font-medium\",\n        s.padding,\n        s.text,\n        isGood && \"bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300\",\n        isBad && \"bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300\",\n        !isGood && !isBad && \"bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300\"\n      )}\n    >\n      <Icon className={s.icon} />\n      {percentage !== 0 && (\n        <>\n          {percentage > 0 ? \"+\" : \"\"}\n          {percentage.toFixed(1)}%\n        </>\n      )}\n      {percentage === 0 && \"No change\"}\n    </span>\n  )\n}\n\nfunction AnomalyBadge({ anomaly }: { anomaly: TrendMetric[\"anomaly\"] }) {\n  if (!anomaly?.detected) return null\n\n  const colors = {\n    info: \"bg-blue-100 text-blue-700 border-blue-300\",\n    warning: \"bg-amber-100 text-amber-700 border-amber-300\",\n    critical: \"bg-red-100 text-red-700 border-red-300 animate-pulse\",\n  }\n\n  return (\n    <TooltipProvider>\n      <Tooltip>\n        <TooltipTrigger>\n          <span\n            className={cn(\n              \"inline-flex items-center gap-1 rounded-md border px-2 py-0.5 text-xs font-medium\",\n              colors[anomaly.severity]\n            )}\n          >\n            <AlertTriangle className=\"h-3 w-3\" />\n            Anomaly\n          </span>\n        </TooltipTrigger>\n        <TooltipContent>\n          <p>{anomaly.message}</p>\n        </TooltipContent>\n      </Tooltip>\n    </TooltipProvider>\n  )\n}\n\n// ============================================================================\n// Metric Card\n// ============================================================================\n\nfunction MetricCard({\n  metric,\n  onDrillDown,\n  showAIInsights,\n  compact,\n}: {\n  metric: TrendMetric\n  onDrillDown?: (metricId: string, period?: string) => void\n  showAIInsights: boolean\n  compact: boolean\n}) {\n  return (\n    <Card\n      className={cn(\n        \"transition-all\",\n        onDrillDown && \"cursor-pointer hover:shadow-md hover:border-primary/50\"\n      )}\n      onClick={() => onDrillDown?.(metric.id)}\n    >\n      <CardContent className={cn(\"pt-4\", compact ? \"pb-3\" : \"pb-4\")}>\n        <div className=\"flex items-start justify-between gap-4\">\n          <div className=\"flex-1 min-w-0\">\n            {/* Header */}\n            <div className=\"flex items-center gap-2 flex-wrap\">\n              <h4 className=\"font-medium text-sm text-muted-foreground\">{metric.name}</h4>\n              <AnomalyBadge anomaly={metric.anomaly} />\n            </div>\n\n            {/* Value */}\n            <div className=\"mt-1 flex items-baseline gap-2\">\n              <span className=\"text-2xl font-bold\">{metric.formattedValue}</span>\n              {metric.unit && (\n                <span className=\"text-sm text-muted-foreground\">{metric.unit}</span>\n              )}\n            </div>\n\n            {/* Trend */}\n            <div className=\"mt-2 flex items-center gap-3\">\n              <TrendIndicator\n                direction={metric.trend.direction}\n                percentage={metric.trend.percentage}\n                isPositive={metric.trend.isPositive}\n                size=\"sm\"\n              />\n            </div>\n\n            {/* Comparisons */}\n            {!compact && metric.comparisons && metric.comparisons.length > 0 && (\n              <div className=\"mt-3 space-y-1\">\n                {metric.comparisons.slice(0, 2).map((comparison) => (\n                  <div\n                    key={comparison.period}\n                    className=\"flex items-center justify-between text-xs\"\n                  >\n                    <span className=\"text-muted-foreground\">{comparison.period}:</span>\n                    <span className=\"font-medium\">\n                      {comparison.formattedValue}\n                      <span\n                        className={cn(\n                          \"ml-1\",\n                          comparison.change > 0 ? \"text-green-600\" : comparison.change < 0 ? \"text-red-600\" : \"text-muted-foreground\"\n                        )}\n                      >\n                        ({comparison.change > 0 ? \"+\" : \"\"}\n                        {comparison.change.toFixed(1)}%)\n                      </span>\n                    </span>\n                  </div>\n                ))}\n              </div>\n            )}\n\n            {/* AI Insight */}\n            {showAIInsights && metric.aiInsight && !compact && (\n              <div className=\"mt-3 rounded-lg bg-primary/5 p-2 text-xs\">\n                <div className=\"flex items-start gap-2\">\n                  <Sparkles className=\"h-3 w-3 text-primary shrink-0 mt-0.5\" />\n                  <p className=\"text-muted-foreground\">{metric.aiInsight}</p>\n                </div>\n              </div>\n            )}\n          </div>\n\n          {/* Sparkline */}\n          <div className=\"shrink-0\">\n            <MiniSparkline dataPoints={metric.dataPoints} trend={metric.trend} />\n          </div>\n        </div>\n\n        {/* Drill-down indicator */}\n        {onDrillDown && (\n          <div className=\"mt-3 flex items-center justify-end text-xs text-muted-foreground\">\n            <span>View details</span>\n            <ChevronRight className=\"h-3 w-3 ml-1\" />\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  )\n}\n\n// ============================================================================\n// Main Component\n// ============================================================================\n\nexport function TrendAnalysisWidget({\n  metrics,\n  periods = [\"This Week\", \"This Month\", \"This Quarter\", \"This Year\"],\n  selectedPeriod = \"This Month\",\n  onPeriodChange,\n  onDrillDown,\n  onRefresh,\n  onExport,\n  showAIInsights = true,\n  compact = false,\n  className,\n}: TrendAnalysisWidgetProps) {\n  const [isRefreshing, setIsRefreshing] = React.useState(false)\n  const [localPeriod, setLocalPeriod] = React.useState(selectedPeriod)\n\n  const handlePeriodChange = (period: string | null) => {\n    if (!period) return\n    setLocalPeriod(period)\n    onPeriodChange?.(period)\n  }\n\n  const handleRefresh = async () => {\n    if (!onRefresh) return\n    setIsRefreshing(true)\n    try {\n      await onRefresh()\n    } finally {\n      setIsRefreshing(false)\n    }\n  }\n\n  // Summary stats\n  const upTrends = metrics.filter((m) => m.trend.direction === \"up\").length\n  const downTrends = metrics.filter((m) => m.trend.direction === \"down\").length\n  const anomalies = metrics.filter((m) => m.anomaly?.detected).length\n\n  return (\n    <Card className={className}>\n      <CardHeader>\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <CardTitle className=\"flex items-center gap-2\">\n              <TrendingUp className=\"h-5 w-5\" />\n              Trend Analysis\n            </CardTitle>\n            <CardDescription>\n              {metrics.length} metric{metrics.length !== 1 ? \"s\" : \"\"} •{\" \"}\n              <span className=\"text-green-600\">{upTrends} up</span> •{\" \"}\n              <span className=\"text-red-600\">{downTrends} down</span>\n              {anomalies > 0 && (\n                <>\n                  {\" \"}\n                  • <span className=\"text-amber-600\">{anomalies} anomal{anomalies !== 1 ? \"ies\" : \"y\"}</span>\n                </>\n              )}\n            </CardDescription>\n          </div>\n          <div className=\"flex items-center gap-2\">\n            <Select value={localPeriod} onValueChange={handlePeriodChange}>\n              <SelectTrigger className=\"w-[140px]\">\n                <Calendar className=\"mr-2 h-4 w-4\" />\n                <SelectValue />\n              </SelectTrigger>\n              <SelectContent>\n                {periods.map((period) => (\n                  <SelectItem key={period} value={period}>\n                    {period}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n            {onRefresh && (\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={handleRefresh}\n                disabled={isRefreshing}\n              >\n                <RefreshCw className={cn(\"h-4 w-4\", isRefreshing && \"animate-spin\")} />\n              </Button>\n            )}\n            {onExport && (\n              <Button variant=\"outline\" size=\"sm\" onClick={() => onExport(\"csv\")}>\n                <Download className=\"h-4 w-4\" />\n              </Button>\n            )}\n          </div>\n        </div>\n      </CardHeader>\n      <CardContent>\n        {metrics.length === 0 ? (\n          <div className=\"flex flex-col items-center justify-center py-12 text-center\">\n            <TrendingUp className=\"h-12 w-12 text-muted-foreground/50\" />\n            <h3 className=\"mt-4 font-semibold\">No trend data</h3>\n            <p className=\"text-sm text-muted-foreground\">\n              Configure metrics to track trends over time\n            </p>\n          </div>\n        ) : (\n          <div className={cn(\"grid gap-4\", compact ? \"md:grid-cols-3\" : \"md:grid-cols-2\")}>\n            {metrics.map((metric) => (\n              <MetricCard\n                key={metric.id}\n                metric={metric}\n                onDrillDown={onDrillDown}\n                showAIInsights={showAIInsights}\n                compact={compact}\n              />\n            ))}\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  )\n}\n\n// ============================================================================\n// Exports\n// ============================================================================\n\nexport type { TrendDataPoint, TrendMetric }\n// TrendDirection is re-exported from blocks/types.ts\n"
    }
  ]
}